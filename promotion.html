<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¹ì§„ ê´€ë¦¬ - êµì› ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/navigation.css">
    <link rel="stylesheet" href="css/print.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .page-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-lg) 0;
            margin-bottom: var(--spacing-lg);
        }

        .page-title {
            font-size: var(--font-size-2xl);
            font-weight: 600;
            margin: 0;
        }

        .date-control-section {
            background: var(--bg-primary);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-color);
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .next-promotion-info {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .next-promotion-info strong {
            color: var(--color-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            text-align: center;
        }

        .stat-number {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .upload-section {
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            text-align: center;
            margin-bottom: var(--spacing-lg);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-section:hover {
            border-color: var(--color-primary);
            background: var(--bg-secondary);
        }

        .upload-section input {
            display: none;
        }

        .search-controls {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            align-items: center;
        }

        .search-controls .form-control {
            flex: 1;
            min-width: 200px;
        }

        .filter-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all 0.15s ease;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }

        .badge-urgent {
            background-color: var(--color-danger);
            color: white;
        }

        .badge-warning {
            background-color: var(--color-warning);
            color: var(--text-primary);
        }

        .badge-normal {
            background-color: var(--color-success);
            color: white;
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">êµì› ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            <button class="navbar-toggle" aria-label="ë©”ë‰´ í† ê¸€">
                <span class="navbar-toggle-icon"></span>
            </button>
            <ul class="navbar-menu">
                <li class="navbar-item">
                    <a href="index.html" class="navbar-link" data-page="dashboard">ëŒ€ì‹œë³´ë“œ</a>
                </li>
                <li class="navbar-item">
                    <a href="promotion.html" class="navbar-link" data-page="promotion">ìŠ¹ì§„</a>
                </li>
                <li class="navbar-item">
                    <a href="reappointment.html" class="navbar-link" data-page="reappointment">ì¬ì„ìš©</a>
                </li>
                <li class="navbar-item">
                    <a href="regulations.html" class="navbar-link" data-page="regulations">ê·œì • ê´€ë¦¬</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header no-print">
        <div class="container">
            <h1 class="page-title">ìŠ¹ì§„ ê´€ë¦¬</h1>
        </div>
    </div>

    <div class="container">
        <!-- ê¸°ì¤€ ë‚ ì§œ ë° ë‹¤ìŒ ìŠ¹ì§„ ì •ë³´ -->
        <div class="date-control-section no-print">
            <div class="date-selector">
                <label for="baseDate" class="form-label mb-0">ê¸°ì¤€ ë‚ ì§œ:</label>
                <input type="date" id="baseDate" class="form-control" style="width: auto;">
                <button class="btn btn-secondary btn-sm" onclick="setToday()">ì˜¤ëŠ˜</button>
                <a href="promotion-process.html" class="btn btn-outline btn-sm">ğŸ“‹ í”„ë¡œì„¸ìŠ¤ ë³´ê¸°</a>
            </div>
            <div class="next-promotion-info" id="nextPromotionInfo">
                ê¸°ì¤€ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid no-print">
            <div class="stat-card">
                <div class="stat-number" id="aprilCount">-</div>
                <div class="stat-label">4ì›” ìŠ¹ì§„ ëŒ€ìƒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="octoberCount">-</div>
                <div class="stat-label">10ì›” ìŠ¹ì§„ ëŒ€ìƒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="urgentCount">-</div>
                <div class="stat-label">ë§ˆê° ì„ë°• (D-30)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCount">-</div>
                <div class="stat-label">ì „ì²´ ëŒ€ìƒì</div>
            </div>
        </div>

        <!-- ì—‘ì…€ ì—…ë¡œë“œ -->
        <div class="upload-section no-print" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="loadExcelFile(event)">
            <div style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-xs);">
                ğŸ“Š êµì›í˜„í™© ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ
            </div>
            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”
            </div>
        </div>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ìŠ¹ì§„ ëŒ€ìƒì ëª©ë¡</h3>
            </div>
            <div class="card-body">
                <div class="search-controls no-print">
                    <input type="text" id="searchBox" class="form-control" placeholder="êµì›ëª…, ì†Œì†, ì§ê¸‰ ê²€ìƒ‰..." onkeyup="filterTable()">
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterByPeriod('all')">ì „ì²´</button>
                        <button class="filter-btn" onclick="filterByPeriod('april')">4ì›” ìŠ¹ì§„</button>
                        <button class="filter-btn" onclick="filterByPeriod('october')">10ì›” ìŠ¹ì§„</button>
                        <button class="filter-btn" onclick="filterByPeriod('urgent')">ë§ˆê° ì„ë°•</button>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="printPromotionList()">ğŸ“„ ì¸ì‡„</button>
                </div>

                <div class="table-wrapper">
                    <table class="table" id="promotionTable">
                        <thead>
                            <tr>
                                <th>ì„±ëª…</th>
                                <th>ì†Œì†</th>
                                <th>í˜„ì§ê¸‰</th>
                                <th>ì„ìš©ì¼</th>
                                <th>ì¬ì§ê¸°ê°„</th>
                                <th>ìŠ¹ì§„ì˜ˆì •ì¼</th>
                                <th>ì„œë¥˜ë§ˆê°</th>
                                <th>D-Day</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="promotionTableBody">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ì¸ì‡„ìš© í—¤ë” (í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€) -->
        <div class="print-only print-header">
            <h1>ìŠ¹ì§„ ì‹¬ì‚¬ ëŒ€ìƒì ëª…ë‹¨</h1>
            <div class="print-info">
                <p>ê¸°ì¤€ì¼: <span id="printBaseDate"></span></p>
                <p>ìŠ¹ì§„ì˜ˆì •ì¼: <span id="printPromotionDate"></span></p>
            </div>
        </div>

        <!-- ì¸ì‡„ìš© í‘¸í„° (í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€) -->
        <div class="print-only print-footer">
            <p>ë°œí–‰ì¼: <span id="printDate"></span></p>
            <p>ë°œí–‰: êµë¬´ì²˜</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/promotion-engine.js"></script>
    <script>
        let facultyData = [];
        let promotionCandidates = [];
        let filteredCandidates = [];
        let currentBaseDate = new Date();
        let promotionEngine = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setToday();
        });

        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
        function setToday() {
            currentBaseDate = new Date();
            document.getElementById('baseDate').value = DateUtils.formatDateForInput(currentBaseDate);
            updatePromotionEngine();
        }

        // ê¸°ì¤€ ë‚ ì§œ ë³€ê²½
        document.getElementById('baseDate')?.addEventListener('change', function(e) {
            if (e.target.value) {
                const parts = e.target.value.split('-');
                currentBaseDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                updatePromotionEngine();
            }
        });

        // ìŠ¹ì§„ ì—”ì§„ ì—…ë°ì´íŠ¸
        function updatePromotionEngine() {
            promotionEngine = new PromotionEngine(currentBaseDate);
            updateNextPromotionInfo();

            if (facultyData.length > 0) {
                calculatePromotions();
            }
        }

        // ë‹¤ìŒ ìŠ¹ì§„ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateNextPromotionInfo() {
            const nextPeriod = promotionEngine.getNextPromotionPeriod();
            const infoElement = document.getElementById('nextPromotionInfo');

            const promotionDateStr = DateUtils.formatDate(nextPeriod.promotionDate);
            const deadlineStr = DateUtils.formatDate(nextPeriod.deadline);
            const daysUntilPromotion = DateUtils.getDaysUntil(nextPeriod.promotionDate, currentBaseDate);
            const daysUntilDeadline = DateUtils.getDaysUntil(nextPeriod.deadline, currentBaseDate);

            infoElement.innerHTML = `
                <div style="display: flex; gap: var(--spacing-xl); flex-wrap: wrap;">
                    <div>
                        <strong>ë‹¤ìŒ ìŠ¹ì§„ì¼:</strong> ${promotionDateStr}
                        <span class="badge badge-primary">${daysUntilPromotion}ì¼ ë‚¨ìŒ</span>
                    </div>
                    <div>
                        <strong>ì„œë¥˜ ë§ˆê°ì¼:</strong> ${deadlineStr}
                        <span class="badge ${daysUntilDeadline <= 30 ? 'badge-danger' : 'badge-secondary'}">
                            ${daysUntilDeadline}ì¼ ë‚¨ìŒ
                        </span>
                    </div>
                </div>
            `;
        }

        // ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        async function loadExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    // í—¤ë” ì°¾ê¸°
                    let headerRowIndex = -1;
                    let headers = [];

                    for (let i = 0; i < rawData.length; i++) {
                        if (rawData[i] && rawData[i][0] === 'No.' && rawData[i].includes('ì„±ëª…')) {
                            headerRowIndex = i;
                            headers = rawData[i];
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        throw new Error('í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    // ë°ì´í„° ì¶”ì¶œ
                    const actualDataRows = rawData.slice(headerRowIndex + 1).filter(row =>
                        row && row.length > 0 && row[0] && typeof row[0] === 'number'
                    );

                    // ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
                    const jsonData = actualDataRows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index];
                        });
                        return obj;
                    });

                    // ì¬ì§ì¤‘ì¸ ì „ì„êµì›ë§Œ í•„í„°ë§
                    facultyData = jsonData.filter(teacher => {
                        const workStatus = teacher['ì¬ì§êµ¬ë¶„'];
                        const position = teacher['ì§ë ¬'];
                        return workStatus && workStatus.toString().includes('ì¬ì§') &&
                               position && position.toString().includes('ì „ì„êµì›');
                    });

                    if (facultyData.length === 0) {
                        alert('ì¬ì§ì¤‘ì¸ ì „ì„êµì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    StorageUtils.set('facultyData', facultyData);
                    StorageUtils.set('lastUploadDate', new Date().toISOString());

                    calculatePromotions();

                } catch (error) {
                    console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // ìŠ¹ì§„ ëŒ€ìƒì ê³„ì‚°
        function calculatePromotions() {
            if (!promotionEngine) {
                promotionEngine = new PromotionEngine(currentBaseDate);
            }

            promotionCandidates = promotionEngine.calculateAllPromotions(facultyData);
            filteredCandidates = [...promotionCandidates];

            updateStatistics();
            updateTable();
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const stats = promotionEngine.calculateStatistics(promotionCandidates);

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('aprilCount').textContent = stats.aprilCount;
            document.getElementById('octoberCount').textContent = stats.octoberCount;
            document.getElementById('urgentCount').textContent = stats.urgentCount;
        }

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateTable() {
            const tbody = document.getElementById('promotionTableBody');
            tbody.innerHTML = '';

            if (filteredCandidates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            ${promotionCandidates.length === 0 ? 'ìŠ¹ì§„ ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}
                        </td>
                    </tr>
                `;
                return;
            }

            filteredCandidates.forEach(candidate => {
                const teacher = candidate.teacher;
                const info = candidate.promotionInfo;

                const row = document.createElement('tr');

                // ìƒíƒœ ë°°ì§€
                let statusBadge = '';
                if (info.daysUntilDeadline !== null && info.daysUntilDeadline <= 30 && info.daysUntilDeadline >= 0) {
                    statusBadge = '<span class="badge badge-urgent">ê¸´ê¸‰</span>';
                } else if (info.daysUntilDeadline !== null && info.daysUntilDeadline <= 60) {
                    statusBadge = '<span class="badge badge-warning">ì£¼ì˜</span>';
                } else {
                    statusBadge = '<span class="badge badge-normal">ì •ìƒ</span>';
                }

                row.innerHTML = `
                    <td>${teacher['ì„±ëª…'] || '-'}</td>
                    <td>${teacher['ì†Œì†'] || '-'}</td>
                    <td>${info.currentRank || '-'}</td>
                    <td>${DateUtils.formatDate(DateUtils.parseDate(teacher['ì „ì„êµì›ìµœì´ˆì„ìš©ì¼'] || teacher['ì „ì„êµì›\nìµœì´ˆì„ìš©ì¼']))}</td>
                    <td>${info.yearsInRank ? info.yearsInRank + 'ë…„' : '-'}</td>
                    <td>${DateUtils.formatDate(info.nextPromotionDate)}</td>
                    <td>${DateUtils.formatDate(info.submissionDeadline)}</td>
                    <td>${info.daysUntilDeadline !== null ? 'D-' + info.daysUntilDeadline : '-'}</td>
                    <td>${statusBadge}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // ê²€ìƒ‰ í•„í„°
        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            filteredCandidates = promotionCandidates.filter(candidate => {
                const teacher = candidate.teacher;
                const name = (teacher['ì„±ëª…'] || '').toLowerCase();
                const department = (teacher['ì†Œì†'] || '').toLowerCase();
                const rank = (teacher['ì§ê¸‰'] || '').toLowerCase();

                return name.includes(searchTerm) ||
                       department.includes(searchTerm) ||
                       rank.includes(searchTerm);
            });

            updateTable();
        }

        // ìŠ¹ì§„ ì‹œê¸°ë³„ í•„í„°
        function filterByPeriod(period) {
            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (period === 'all') {
                filteredCandidates = [...promotionCandidates];
            } else if (period === 'urgent') {
                filteredCandidates = promotionCandidates.filter(candidate => {
                    const daysUntilDeadline = candidate.promotionInfo.daysUntilDeadline;
                    return daysUntilDeadline !== null && daysUntilDeadline <= 30 && daysUntilDeadline >= 0;
                });
            } else {
                const stats = promotionEngine.calculateStatistics(promotionCandidates);
                filteredCandidates = stats.groups[period] || [];
            }

            updateTable();
        }

        // ì¸ì‡„
        function printPromotionList() {
            // ì¸ì‡„ìš© ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('printBaseDate').textContent = DateUtils.formatDate(currentBaseDate);

            const nextPeriod = promotionEngine.getNextPromotionPeriod();
            document.getElementById('printPromotionDate').textContent = DateUtils.formatDate(nextPeriod.promotionDate);
            document.getElementById('printDate').textContent = DateUtils.formatDate(new Date());

            // ì¸ì‡„
            window.print();
        }

        // íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const uploadSection = document.querySelector('.upload-section');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = 'var(--color-primary)';
        });

        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = 'var(--border-color)';
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = 'var(--border-color)';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const event = { target: { files: [files[0]] } };
                loadExcelFile(event);
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë³µì›
        window.addEventListener('load', () => {
            const savedData = StorageUtils.get('facultyData');
            if (savedData) {
                facultyData = savedData;
                calculatePromotions();
            }
        });
    </script>
</body>
</html>
