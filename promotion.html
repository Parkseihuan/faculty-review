<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¹ì§„ ê´€ë¦¬ - êµì› ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/navigation.css">
    <link rel="stylesheet" href="css/print.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .page-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-lg) 0;
            margin-bottom: var(--spacing-lg);
        }

        .page-title {
            font-size: var(--font-size-2xl);
            font-weight: 600;
            margin: 0;
        }

        .date-control-section {
            background: var(--bg-primary);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-color);
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .next-promotion-info {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .next-promotion-info strong {
            color: var(--color-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            text-align: center;
        }

        .stat-number {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .search-controls {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            align-items: center;
        }

        .search-controls .form-control {
            flex: 1;
            min-width: 200px;
        }

        .filter-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all 0.15s ease;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }

        .badge-urgent {
            background-color: var(--color-danger);
            color: white;
        }

        .badge-warning {
            background-color: var(--color-warning);
            color: var(--text-primary);
        }

        .badge-normal {
            background-color: var(--color-success);
            color: white;
        }

        .promotion-group {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .group-header {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--color-primary) 0%, #667eea 100%);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
        }

        .promotion-group h4 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--color-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            background: white;
            border-left: 4px solid var(--color-primary);
            border-radius: var(--radius-sm);
            margin: var(--spacing-md) 0;
        }

        .subgroup-section {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .subgroup-header {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-secondary);
            border-left: 4px solid var(--color-success);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
        }

        .promotion-group .table-wrapper {
            margin-bottom: 0;
            border: none;
        }

        .promotion-group .table {
            margin-bottom: 0;
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs-container {
            margin-bottom: var(--spacing-lg);
        }

        .tabs-nav {
            display: flex;
            gap: var(--spacing-xs);
            border-bottom: 2px solid var(--border-color);
            margin-bottom: var(--spacing-lg);
        }

        .tab-button {
            padding: var(--spacing-md) var(--spacing-lg);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: var(--font-size-md);
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            position: relative;
            bottom: -2px;
        }

        .tab-button:hover {
            color: var(--color-primary);
            background: var(--bg-secondary);
        }

        .tab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">êµì› ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            <button class="navbar-toggle" aria-label="ë©”ë‰´ í† ê¸€">
                <span class="navbar-toggle-icon"></span>
            </button>
            <ul class="navbar-menu">
                <li class="navbar-item">
                    <a href="index.html" class="navbar-link" data-page="dashboard">ëŒ€ì‹œë³´ë“œ</a>
                </li>
                <li class="navbar-item">
                    <a href="promotion.html" class="navbar-link" data-page="promotion">ìŠ¹ì§„</a>
                </li>
                <li class="navbar-item">
                    <a href="reappointment.html" class="navbar-link" data-page="reappointment">ì¬ì„ìš©</a>
                </li>
                <li class="navbar-item">
                    <a href="data-management.html" class="navbar-link" data-page="data">ë°ì´í„° ê´€ë¦¬</a>
                </li>
                <li class="navbar-item">
                    <a href="process.html" class="navbar-link" data-page="process">í”„ë¡œì„¸ìŠ¤ & ê·œì •</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header no-print">
        <div class="container">
            <h1 class="page-title">ìŠ¹ì§„ ê´€ë¦¬</h1>
        </div>
    </div>

    <div class="container">
        <!-- ê¸°ì¤€ ë‚ ì§œ ë° ë‹¤ìŒ ìŠ¹ì§„ ì •ë³´ -->
        <div class="date-control-section no-print">
            <div class="date-selector">
                <label for="baseDate" class="form-label mb-0">ê¸°ì¤€ ë‚ ì§œ:</label>
                <input type="date" id="baseDate" class="form-control" style="width: auto;">
                <button class="btn btn-secondary btn-sm" onclick="setToday()">ì˜¤ëŠ˜</button>
                <a href="promotion-process.html" class="btn btn-outline btn-sm">ğŸ“‹ í”„ë¡œì„¸ìŠ¤ ë³´ê¸°</a>
            </div>
            <div class="next-promotion-info" id="nextPromotionInfo">
                ê¸°ì¤€ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid no-print">
            <div class="stat-card">
                <div class="stat-number" id="aprilCount">-</div>
                <div class="stat-label">4ì›” ìŠ¹ì§„ ëŒ€ìƒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="octoberCount">-</div>
                <div class="stat-label">10ì›” ìŠ¹ì§„ ëŒ€ìƒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="urgentCount">-</div>
                <div class="stat-label">ë§ˆê° ì„ë°• (D-30)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCount">-</div>
                <div class="stat-label">ì „ì²´ ëŒ€ìƒì</div>
            </div>
        </div>

        <!-- íƒ­ UI -->
        <div class="tabs-container">
            <div class="tabs-nav no-print">
                <button class="tab-button active" onclick="switchTab('candidates')">ğŸ“‹ ìŠ¹ì§„ ëŒ€ìƒì ëª©ë¡</button>
                <button class="tab-button" onclick="switchTab('exceptions')">âš™ï¸ ì˜ˆì™¸ ì‚¬í•­ ê´€ë¦¬</button>
            </div>

            <!-- íƒ­1: ìŠ¹ì§„ ëŒ€ìƒì ëª©ë¡ -->
            <div id="tab-candidates" class="tab-content active">
                <!-- ê²€ìƒ‰ ë° í•„í„° -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ìŠ¹ì§„ ëŒ€ìƒì ëª©ë¡ (ë‹¹í•´ ì—°ë„)</h3>
                    </div>
                    <div class="card-body">
                        <div class="search-controls no-print">
                            <input type="text" id="searchBox" class="form-control" placeholder="êµì›ëª…, ì†Œì†, ì§ê¸‰ ê²€ìƒ‰..." onkeyup="filterTable()">
                            <div class="filter-buttons">
                                <button class="filter-btn active" onclick="filterByPeriod('all')">ì „ì²´</button>
                                <button class="filter-btn" onclick="filterByPeriod('april')">4ì›” ìŠ¹ì§„</button>
                                <button class="filter-btn" onclick="filterByPeriod('october')">10ì›” ìŠ¹ì§„</button>
                                <button class="filter-btn" onclick="filterByPeriod('urgent')">ë§ˆê° ì„ë°•</button>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="printPromotionList()">ğŸ“„ ì¸ì‡„</button>
                        </div>

                        <div id="promotionGroupsContainer">
                            <div class="empty-state" style="padding: var(--spacing-xl); text-align: center; color: var(--text-muted);">
                                ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- íƒ­2: ì˜ˆì™¸ ì‚¬í•­ ê´€ë¦¬ -->
            <div id="tab-exceptions" class="tab-content">
                <div class="card no-print">
            <div class="card-header">
                <h3 class="card-title">ì˜ˆì™¸ ì‚¬í•­ ê´€ë¦¬</h3>
            </div>
            <div class="card-body">
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                    ì‚¬ì§ì„œ ì œì¶œ, ìŠ¹ì§„ íƒˆë½, íœ´ì§ ë“±ì˜ ì‚¬ìœ ë¡œ ìŠ¹ì§„ ëŒ€ìƒìì—ì„œ ì œì™¸í•  êµì›ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
                </p>

                <!-- ì˜ˆì™¸ ì¶”ê°€ í¼ -->
                <div style="background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label">ì†Œì†í•™ê³¼ *</label>
                        <input type="text" id="exceptionDepartment" class="form-control" placeholder="ì˜ˆ: ê¸°ê³„ê³µí•™ê³¼">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì„±ëª… *</label>
                        <input type="text" id="exceptionName" class="form-control" placeholder="ì˜ˆ: í™ê¸¸ë™">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì˜ˆì™¸ ìœ í˜• *</label>
                        <select id="exceptionType" class="form-control" onchange="togglePromotionDateField()">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="resignation">ì‚¬ì§ì„œ ì œì¶œ (ì˜êµ¬ ì œì™¸)</option>
                            <option value="failed">ìŠ¹ì§„ íƒˆë½ (íŠ¹ì • ìŠ¹ì§„ì¼ë§Œ ì œì™¸)</option>
                            <option value="leave">íœ´ì§ (íŠ¹ì • ìŠ¹ì§„ì¼ë§Œ ì œì™¸)</option>
                            <option value="discipline">ì§•ê³„ (íŠ¹ì • ìŠ¹ì§„ì¼ë§Œ ì œì™¸)</option>
                            <option value="other">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group" id="promotionDateGroup" style="display: none;">
                        <label class="form-label">ì ìš© ìŠ¹ì§„ì¼ (ì´ ìŠ¹ì§„ì¼ì—ë§Œ ì œì™¸) *</label>
                        <input type="date" id="exceptionPromotionDate" class="form-control">
                        <small style="color: var(--text-muted); font-size: var(--font-size-sm);">
                            ìŠ¹ì§„ íƒˆë½, íœ´ì§ ë“±ì˜ ê²½ìš° ì œì™¸í•  íŠ¹ì • ìŠ¹ì§„ì¼ì„ ì§€ì •í•˜ì„¸ìš”. (ì˜ˆ: 2025-10-01)
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì‚¬ìœ </label>
                        <input type="text" id="exceptionReason" class="form-control" placeholder="ì˜ˆ: ìŠ¹ì§„ì„ìš© ê¸°ê°„ ì „ ì‚¬ì§ì„œ ì œì¶œ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë¹„ê³ </label>
                        <textarea id="exceptionNote" class="form-control" rows="2" placeholder="ì¶”ê°€ ìƒì„¸ ì •ë³´"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addException()">ì˜ˆì™¸ ì‚¬í•­ ì¶”ê°€</button>
                </div>

                <!-- ì˜ˆì™¸ ëª©ë¡ -->
                <div id="exceptionsList">
                    <p class="text-center text-muted p-3">ë“±ë¡ëœ ì˜ˆì™¸ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
            </div>
        </div>

        <!-- ì¸ì‡„ìš© í—¤ë” (í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€) -->
        <div class="print-only print-header">
            <h1>ìŠ¹ì§„ ì‹¬ì‚¬ ëŒ€ìƒì ëª…ë‹¨</h1>
            <div class="print-info">
                <p>ê¸°ì¤€ì¼: <span id="printBaseDate"></span></p>
                <p>ìŠ¹ì§„ì˜ˆì •ì¼: <span id="printPromotionDate"></span></p>
            </div>
        </div>

        <!-- ì¸ì‡„ìš© í‘¸í„° (í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€) -->
        <div class="print-only print-footer">
            <p>ë°œí–‰ì¼: <span id="printDate"></span></p>
            <p>ë°œí–‰: êµë¬´ì²˜</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/promotion-engine.js"></script>
    <script>
        let facultyData = [];
        let promotionCandidates = [];
        let filteredCandidates = [];
        let currentBaseDate = new Date();
        let promotionEngine = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setToday();
            loadExceptionsList();
        });

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
        function setToday() {
            currentBaseDate = new Date();
            document.getElementById('baseDate').value = DateUtils.formatDateForInput(currentBaseDate);
            updatePromotionEngine();
        }

        // ê¸°ì¤€ ë‚ ì§œ ë³€ê²½
        document.getElementById('baseDate')?.addEventListener('change', function(e) {
            if (e.target.value) {
                const parts = e.target.value.split('-');
                currentBaseDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                updatePromotionEngine();
            }
        });

        // ìŠ¹ì§„ ì—”ì§„ ì—…ë°ì´íŠ¸
        function updatePromotionEngine() {
            promotionEngine = new PromotionEngine(currentBaseDate);
            updateNextPromotionInfo();

            if (facultyData.length > 0) {
                calculatePromotions();
            }
        }

        // ë‹¤ìŒ ìŠ¹ì§„ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateNextPromotionInfo() {
            const nextPeriod = promotionEngine.getNextPromotionPeriod();
            const infoElement = document.getElementById('nextPromotionInfo');

            const promotionDateStr = DateUtils.formatDate(nextPeriod.promotionDate);
            const deadlineStr = DateUtils.formatDate(nextPeriod.deadline);
            const daysUntilPromotion = DateUtils.getDaysUntil(nextPeriod.promotionDate, currentBaseDate);
            const daysUntilDeadline = DateUtils.getDaysUntil(nextPeriod.deadline, currentBaseDate);

            infoElement.innerHTML = `
                <div style="display: flex; gap: var(--spacing-xl); flex-wrap: wrap;">
                    <div>
                        <strong>ë‹¤ìŒ ìŠ¹ì§„ì¼:</strong> ${promotionDateStr}
                        <span class="badge badge-primary">${daysUntilPromotion}ì¼ ë‚¨ìŒ</span>
                    </div>
                    <div>
                        <strong>ì„œë¥˜ ë§ˆê°ì¼:</strong> ${deadlineStr}
                        <span class="badge ${daysUntilDeadline <= 30 ? 'badge-danger' : 'badge-secondary'}">
                            ${daysUntilDeadline}ì¼ ë‚¨ìŒ
                        </span>
                    </div>
                </div>
            `;
        }

        // ìŠ¹ì§„ ëŒ€ìƒì ê³„ì‚°
        function calculatePromotions() {
            if (!promotionEngine) {
                promotionEngine = new PromotionEngine(currentBaseDate);
            }

            console.log('ì „ì²´ êµì› ìˆ˜:', facultyData.length);
            promotionCandidates = promotionEngine.calculateAllPromotions(facultyData);
            console.log('ìŠ¹ì§„ ëŒ€ìƒì ìˆ˜:', promotionCandidates.length);

            filteredCandidates = [...promotionCandidates];

            updateStatistics();
            updateTable();
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const stats = promotionEngine.calculateStatistics(promotionCandidates);

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('aprilCount').textContent = stats.aprilCount;
            document.getElementById('octoberCount').textContent = stats.octoberCount;
            document.getElementById('urgentCount').textContent = stats.urgentCount;
        }

        // í…Œì´ë¸” í–‰ ìƒì„± í—¬í¼ í•¨ìˆ˜
        function createTableRow(candidate) {
            const teacher = candidate.teacher;
            const info = candidate.promotionInfo;

            // ìƒíƒœ ë°°ì§€
            let statusBadge = '';
            if (info.daysUntilDeadline !== null && info.daysUntilDeadline <= 30 && info.daysUntilDeadline >= 0) {
                statusBadge = '<span class="badge badge-urgent">ê¸´ê¸‰</span>';
            } else if (info.daysUntilDeadline !== null && info.daysUntilDeadline <= 60) {
                statusBadge = '<span class="badge badge-warning">ì£¼ì˜</span>';
            } else {
                statusBadge = '<span class="badge badge-normal">ì •ìƒ</span>';
            }

            // ì„ìš©ì¼ ê°€ì ¸ì˜¤ê¸°
            const firstAppointmentField = promotionEngine.getTeacherValue(teacher, 'ì „ì„êµì›\nìµœì´ˆì„ìš©ì¼');
            const firstAppointmentDate = DateUtils.parseDate(firstAppointmentField);

            return `
                <tr>
                    <td>${teacher['ì„±ëª…'] || '-'}</td>
                    <td>${teacher['ì†Œì†'] || '-'}</td>
                    <td>${info.currentRank || '-'}</td>
                    <td>${DateUtils.formatDate(firstAppointmentDate)}</td>
                    <td>${info.yearsInRank ? info.yearsInRank + 'ë…„' : '-'}</td>
                    <td>${DateUtils.formatDate(info.nextPromotionDate)}</td>
                    <td>${DateUtils.formatDate(info.submissionDeadline)}</td>
                    <td>${info.daysUntilDeadline !== null ? 'D-' + info.daysUntilDeadline : '-'}</td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        }

        // ê·¸ë£¹ë³„ í…Œì´ë¸” ë Œë”ë§
        function renderGroupTable(candidates, title) {
            if (candidates.length === 0) return '';

            let html = '<div class="subgroup-section">';
            html += `<div class="subgroup-header">${title} (${candidates.length}ëª…)</div>`;
            html += '<div class="table-wrapper">';
            html += '<table class="table">';
            html += `
                <thead>
                    <tr>
                        <th>ì„±ëª…</th>
                        <th>ì†Œì†</th>
                        <th>í˜„ì§ê¸‰</th>
                        <th>ì„ìš©ì¼</th>
                        <th>ì¬ì§ê¸°ê°„</th>
                        <th>ìŠ¹ì§„ì˜ˆì •ì¼</th>
                        <th>ì„œë¥˜ë§ˆê°</th>
                        <th>D-Day</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody>
            `;

            candidates.forEach(candidate => {
                html += createTableRow(candidate);
            });

            html += '</tbody></table></div></div>';
            return html;
        }

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ê·¸ë£¹ë³„)
        function updateTable() {
            const container = document.getElementById('promotionGroupsContainer');

            if (filteredCandidates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: var(--spacing-xl); text-align: center; color: var(--text-muted);">
                        ${promotionCandidates.length === 0 ? 'ìŠ¹ì§„ ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}
                    </div>
                `;
                return;
            }

            // ê·¸ë£¹í™”
            const stats = promotionEngine.calculateStatistics(filteredCandidates);
            let html = '';

            // ì‹œê¸°ë³„ë¡œ ê·¸ë£¹í™”
            ['april', 'october'].forEach(period => {
                const periodCandidates = stats.groups[period];
                if (periodCandidates.length === 0) return;

                const periodGroups = promotionEngine.groupByTrackAndPath(periodCandidates);
                const periodLabel = period === 'april' ? '4ì›” ìŠ¹ì§„ ëŒ€ìƒì' : '10ì›” ìŠ¹ì§„ ëŒ€ìƒì';

                html += '<div class="promotion-group">';
                html += `<div class="group-header">${periodLabel}</div>`;

                // ì •ë…„íŠ¸ë™ ì „ì„êµì›
                if (periodGroups.tenure.associateToFull.length > 0 || periodGroups.tenure.assistantToAssociate.length > 0) {
                    html += '<h4 style="font-size: var(--font-size-lg); font-weight: 600; margin: var(--spacing-md) 0;">ì •ë…„íŠ¸ë™ ì „ì„êµì›</h4>';

                    // ë¶€êµìˆ˜ -> êµìˆ˜
                    html += renderGroupTable(periodGroups.tenure.associateToFull, 'â–¸ ë¶€êµìˆ˜ â†’ êµìˆ˜');

                    // ì¡°êµìˆ˜ -> ë¶€êµìˆ˜
                    html += renderGroupTable(periodGroups.tenure.assistantToAssociate, 'â–¸ ì¡°êµìˆ˜ â†’ ë¶€êµìˆ˜');
                }

                // ë¹„ì •ë…„íŠ¸ë™ ì „ì„êµì›
                if (periodGroups.nonTenure.assistantToAssociate.length > 0) {
                    html += '<h4 style="font-size: var(--font-size-lg); font-weight: 600; margin: var(--spacing-md) 0;">ë¹„ì •ë…„íŠ¸ë™ ì „ì„êµì›</h4>';
                    html += renderGroupTable(periodGroups.nonTenure.assistantToAssociate, 'â–¸ ì¡°êµìˆ˜ â†’ ë¶€êµìˆ˜');
                }

                html += '</div>';
            });

            container.innerHTML = html;
        }

        // ê²€ìƒ‰ í•„í„°
        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            filteredCandidates = promotionCandidates.filter(candidate => {
                const teacher = candidate.teacher;
                const name = (teacher['ì„±ëª…'] || '').toLowerCase();
                const department = (teacher['ì†Œì†'] || '').toLowerCase();
                const rank = (teacher['ì§ê¸‰'] || '').toLowerCase();

                return name.includes(searchTerm) ||
                       department.includes(searchTerm) ||
                       rank.includes(searchTerm);
            });

            updateTable();
        }

        // ìŠ¹ì§„ ì‹œê¸°ë³„ í•„í„°
        function filterByPeriod(period) {
            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (period === 'all') {
                filteredCandidates = [...promotionCandidates];
            } else if (period === 'urgent') {
                filteredCandidates = promotionCandidates.filter(candidate => {
                    const daysUntilDeadline = candidate.promotionInfo.daysUntilDeadline;
                    return daysUntilDeadline !== null && daysUntilDeadline <= 30 && daysUntilDeadline >= 0;
                });
            } else {
                const stats = promotionEngine.calculateStatistics(promotionCandidates);
                filteredCandidates = stats.groups[period] || [];
            }

            updateTable();
        }

        // ì¸ì‡„
        function printPromotionList() {
            // ì¸ì‡„ìš© ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('printBaseDate').textContent = DateUtils.formatDate(currentBaseDate);

            const nextPeriod = promotionEngine.getNextPromotionPeriod();
            document.getElementById('printPromotionDate').textContent = DateUtils.formatDate(nextPeriod.promotionDate);
            document.getElementById('printDate').textContent = DateUtils.formatDate(new Date());

            // ì¸ì‡„
            window.print();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë³µì›
        window.addEventListener('load', () => {
            const savedData = StorageUtils.get('facultyData');
            if (savedData) {
                facultyData = savedData;
                calculatePromotions();
            }
        });

        // ===== ì˜ˆì™¸ ì‚¬í•­ ê´€ë¦¬ í•¨ìˆ˜ =====

        // ì˜ˆì™¸ ìœ í˜•ì— ë”°ë¼ ìŠ¹ì§„ì¼ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        function togglePromotionDateField() {
            const type = document.getElementById('exceptionType').value;
            const promotionDateGroup = document.getElementById('promotionDateGroup');
            const promotionDateInput = document.getElementById('exceptionPromotionDate');

            // ì‚¬ì§(resignation)ê³¼ ê¸°íƒ€(other)ëŠ” ì˜êµ¬ ì œì™¸ì´ë¯€ë¡œ ìŠ¹ì§„ì¼ ë¶ˆí•„ìš”
            if (type === 'failed' || type === 'leave' || type === 'discipline') {
                promotionDateGroup.style.display = 'block';
                promotionDateInput.required = true;
            } else {
                promotionDateGroup.style.display = 'none';
                promotionDateInput.required = false;
                promotionDateInput.value = '';
            }
        }

        // ì˜ˆì™¸ ìœ í˜• í•œê¸€ ë ˆì´ë¸”
        function getExceptionTypeLabel(type) {
            const labels = {
                'resignation': 'ì‚¬ì§ì„œ ì œì¶œ',
                'failed': 'ìŠ¹ì§„ íƒˆë½',
                'leave': 'íœ´ì§',
                'discipline': 'ì§•ê³„',
                'other': 'ê¸°íƒ€'
            };
            return labels[type] || type;
        }

        // ì˜ˆì™¸ ì‚¬í•­ ì¶”ê°€
        function addException() {
            const department = document.getElementById('exceptionDepartment').value.trim();
            const name = document.getElementById('exceptionName').value.trim();
            const type = document.getElementById('exceptionType').value;
            const promotionDate = document.getElementById('exceptionPromotionDate').value;
            const reason = document.getElementById('exceptionReason').value.trim();
            const note = document.getElementById('exceptionNote').value.trim();

            // í•„ìˆ˜ í•­ëª© ê²€ì¦
            if (!department) {
                alert('ì†Œì†í•™ê³¼ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                document.getElementById('exceptionDepartment').focus();
                return;
            }

            if (!name) {
                alert('ì„±ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
                document.getElementById('exceptionName').focus();
                return;
            }

            if (!type) {
                alert('ì˜ˆì™¸ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.');
                document.getElementById('exceptionType').focus();
                return;
            }

            // ìŠ¹ì§„ íƒˆë½, íœ´ì§, ì§•ê³„ì˜ ê²½ìš° ìŠ¹ì§„ì¼ í•„ìˆ˜
            if ((type === 'failed' || type === 'leave' || type === 'discipline') && !promotionDate) {
                alert('ì ìš© ìŠ¹ì§„ì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                document.getElementById('exceptionPromotionDate').focus();
                return;
            }

            // ì˜ˆì™¸ ê°ì²´ ìƒì„±
            const exception = {
                department: department,
                name: name,
                type: type,
                promotionDate: promotionDate || null,  // íŠ¹ì • ìŠ¹ì§„ì¼ (ë˜ëŠ” null = ì˜êµ¬ ì œì™¸)
                reason: reason || '',
                note: note || '',
                isActive: true,
                addedDate: new Date().toISOString()
            };

            // ê¸°ì¡´ ì˜ˆì™¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const exceptions = promotionEngine.getExceptions();

            // ì¤‘ë³µ í™•ì¸
            const duplicate = exceptions.find(ex =>
                ex.name === name &&
                ex.department === department &&
                ex.isActive
            );

            if (duplicate) {
                if (!confirm(`${name} (${department})ëŠ” ì´ë¯¸ ì˜ˆì™¸ ëª©ë¡ì— ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\nê³„ì† ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }

            // ì¶”ê°€
            exceptions.push(exception);
            promotionEngine.saveExceptions(exceptions);

            // í¼ ì´ˆê¸°í™”
            document.getElementById('exceptionDepartment').value = '';
            document.getElementById('exceptionName').value = '';
            document.getElementById('exceptionType').value = '';
            document.getElementById('exceptionPromotionDate').value = '';
            document.getElementById('exceptionReason').value = '';
            document.getElementById('exceptionNote').value = '';
            document.getElementById('promotionDateGroup').style.display = 'none';

            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadExceptionsList();

            // ìŠ¹ì§„ ëŒ€ìƒì ì¬ê³„ì‚°
            if (facultyData.length > 0) {
                calculatePromotions();
            }

            alert('ì˜ˆì™¸ ì‚¬í•­ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì˜ˆì™¸ ëª©ë¡ ë¡œë“œ
        function loadExceptionsList() {
            if (!promotionEngine) {
                promotionEngine = new PromotionEngine(currentBaseDate);
            }

            const exceptions = promotionEngine.getExceptions();
            const container = document.getElementById('exceptionsList');

            if (exceptions.length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-3">ë“±ë¡ëœ ì˜ˆì™¸ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">';

            exceptions.forEach((exception, index) => {
                const typeLabel = getExceptionTypeLabel(exception.type);
                const addedDate = new Date(exception.addedDate);
                const dateStr = DateUtils.formatDate(addedDate);

                html += `
                    <div style="background: white; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-md); ${!exception.isActive ? 'opacity: 0.5;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: var(--font-size-lg); margin-bottom: var(--spacing-xs);">
                                    ${exception.name} <span style="color: var(--text-secondary); font-weight: 400; font-size: var(--font-size-sm);">(${exception.department})</span>
                                </div>
                                <div style="margin-bottom: var(--spacing-xs);">
                                    <span class="badge badge-${exception.isActive ? 'primary' : 'secondary'}">${typeLabel}</span>
                                    ${exception.promotionDate ? `<span class="badge badge-warning">${exception.promotionDate} ì œì™¸</span>` : '<span class="badge badge-danger">ì˜êµ¬ ì œì™¸</span>'}
                                    ${!exception.isActive ? '<span class="badge badge-secondary">ë¹„í™œì„±</span>' : ''}
                                </div>
                                ${exception.reason ? `<div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">ì‚¬ìœ : ${exception.reason}</div>` : ''}
                                ${exception.note ? `<div style="color: var(--text-muted); font-size: var(--font-size-sm);">ë¹„ê³ : ${exception.note}</div>` : ''}
                                <div style="color: var(--text-muted); font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">ë“±ë¡ì¼: ${dateStr}</div>
                            </div>
                            <div style="display: flex; gap: var(--spacing-xs);">
                                <button class="btn btn-sm btn-outline" onclick="toggleException(${index})" title="${exception.isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}">
                                    ${exception.isActive ? 'â¸ï¸' : 'â–¶ï¸'}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteException(${index})" title="ì‚­ì œ">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ì˜ˆì™¸ ì‚­ì œ
        function deleteException(index) {
            const exceptions = promotionEngine.getExceptions();
            const exception = exceptions[index];

            if (!confirm(`${exception.name} (${exception.department})ì˜ ì˜ˆì™¸ ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            exceptions.splice(index, 1);
            promotionEngine.saveExceptions(exceptions);

            loadExceptionsList();

            // ìŠ¹ì§„ ëŒ€ìƒì ì¬ê³„ì‚°
            if (facultyData.length > 0) {
                calculatePromotions();
            }
        }

        // ì˜ˆì™¸ í™œì„±í™”/ë¹„í™œì„±í™” í† ê¸€
        function toggleException(index) {
            const exceptions = promotionEngine.getExceptions();
            exceptions[index].isActive = !exceptions[index].isActive;

            promotionEngine.saveExceptions(exceptions);

            loadExceptionsList();

            // ìŠ¹ì§„ ëŒ€ìƒì ì¬ê³„ì‚°
            if (facultyData.length > 0) {
                calculatePromotions();
            }
        }
    </script>
</body>
</html>
