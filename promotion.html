<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¹ì§„ ê´€ë¦¬ - êµì› ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/navigation.css">
    <link rel="stylesheet" href="css/print.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .page-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-lg) 0;
            margin-bottom: var(--spacing-lg);
        }

        .page-title {
            font-size: var(--font-size-3xl);
            font-weight: 600;
            margin: 0;
        }

        .date-control-section {
            background: var(--bg-primary);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-color);
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .next-promotion-info {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .next-promotion-info strong {
            color: var(--color-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            text-align: center;
        }

        .stat-number {
            font-size: var(--font-size-stat);
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .search-controls {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            align-items: center;
        }

        .search-controls .form-control {
            flex: 1;
            min-width: 200px;
        }

        .filter-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all 0.15s ease;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }

        .badge-urgent {
            background-color: var(--color-danger);
            color: white;
        }

        .badge-warning {
            background-color: var(--color-warning);
            color: var(--text-primary);
        }

        .badge-normal {
            background-color: var(--color-success);
            color: white;
        }

        .promotion-group {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .group-header {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--color-primary) 0%, #667eea 100%);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
        }

        .promotion-group h4 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--color-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            background: white;
            border-left: 4px solid var(--color-primary);
            border-radius: var(--radius-sm);
            margin: var(--spacing-md) 0;
        }

        .subgroup-section {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .subgroup-header {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-secondary);
            border-left: 4px solid var(--color-success);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
        }

        .promotion-group .table-wrapper {
            margin-bottom: 0;
            border: none;
        }

        .promotion-group .table {
            margin-bottom: 0;
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs-container {
            margin-bottom: var(--spacing-lg);
        }

        .tabs-nav {
            display: flex;
            gap: var(--spacing-xs);
            border-bottom: 2px solid var(--border-color);
            margin-bottom: var(--spacing-lg);
        }

        .tab-button {
            padding: var(--spacing-md) var(--spacing-lg);
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: var(--font-size-md);
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            position: relative;
            bottom: -2px;
        }

        .tab-button:hover {
            color: var(--color-primary);
            background: var(--bg-secondary);
        }

        .tab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* êµì› ìƒì„¸ ëª¨ë‹¬ */
        .teacher-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .teacher-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-primary);
            margin: var(--spacing-lg);
            padding: 0;
            border-radius: var(--radius-lg);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 2px solid var(--border-color);
            background: linear-gradient(135deg, var(--color-primary) 0%, #667eea 100%);
            color: white;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            margin: 0;
            font-size: var(--font-size-2xl);
            font-weight: 600;
        }

        .modal-close {
            position: absolute;
            right: var(--spacing-lg);
            top: var(--spacing-lg);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 28px;
            font-weight: 300;
            color: white;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            padding: var(--spacing-xl);
        }

        .info-section {
            margin-bottom: var(--spacing-xl);
        }

        .info-section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--color-primary);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .info-item {
            padding: var(--spacing-sm);
        }

        .info-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .info-value {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--text-primary);
        }

        .timeline {
            position: relative;
            padding-left: var(--spacing-lg);
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .timeline-item {
            position: relative;
            padding-bottom: var(--spacing-lg);
            padding-left: var(--spacing-lg);
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-dot {
            position: absolute;
            left: -5px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--color-primary);
            border: 2px solid var(--bg-primary);
        }

        .timeline-dot.leave {
            background: var(--color-warning);
        }

        .timeline-dot.reappointment {
            background: var(--color-info);
        }

        .timeline-content {
            background: var(--bg-secondary);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--color-primary);
        }

        .timeline-content.leave {
            border-left-color: var(--color-warning);
        }

        .timeline-content.reappointment {
            border-left-color: var(--color-info);
        }

        .timeline-date {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: var(--spacing-xs);
        }

        .timeline-title {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .timeline-description {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin: 0;
        }

        .summary-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 600;
            margin-right: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
        }

        .summary-badge.primary {
            background: var(--color-primary);
            color: white;
        }

        .summary-badge.warning {
            background: var(--color-warning);
            color: var(--text-primary);
        }

        .summary-badge.info {
            background: var(--color-info);
            color: white;
        }

        /* íŠ¹ë³„ ê´€ë¦¬ ëŒ€ìƒ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .special-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            overflow: hidden;
        }

        .special-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .special-card-header h4 {
            margin: 0;
            font-size: var(--font-size-lg);
        }

        .special-card-header .badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
        }

        .special-card-body {
            padding: var(--spacing-md);
        }

        .special-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        .special-table th, .special-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .special-table th {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .special-table tr.leave-row {
            background: #fff3cd;
        }

        .special-table tr.current-row {
            background: #d4edda;
            font-weight: 600;
        }

        .special-table tr.return-row {
            background: #cce5ff;
        }

        .special-table tr.sick-row {
            background: #f8f9fa;
            color: var(--text-muted);
        }

        .special-table tr.expected-row {
            background: #cce5ff;
            font-weight: 600;
            color: #004085;
        }

        .special-conclusion {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: var(--radius-sm);
        }

        .special-actions {
            margin-top: var(--spacing-md);
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">êµì› ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            <button class="navbar-toggle" aria-label="ë©”ë‰´ í† ê¸€">
                <span class="navbar-toggle-icon"></span>
            </button>
            <ul class="navbar-menu">
                <li class="navbar-item">
                    <a href="index.html" class="navbar-link" data-page="dashboard">ëŒ€ì‹œë³´ë“œ</a>
                </li>
                <li class="navbar-item">
                    <a href="promotion.html" class="navbar-link" data-page="promotion">ìŠ¹ì§„</a>
                </li>
                <li class="navbar-item">
                    <a href="reappointment.html" class="navbar-link" data-page="reappointment">ì¬ì„ìš©</a>
                </li>
                <li class="navbar-item">
                    <a href="data-management.html" class="navbar-link" data-page="data">ë°ì´í„° ê´€ë¦¬</a>
                </li>
                <li class="navbar-item">
                    <a href="process.html" class="navbar-link" data-page="process">í”„ë¡œì„¸ìŠ¤ & ê·œì •</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header no-print">
        <div class="container">
            <h1 class="page-title">ìŠ¹ì§„ ê´€ë¦¬</h1>
        </div>
    </div>

    <div class="container">
        <!-- êµì›ì¸ì‚¬ê·œì • ì•ˆë‚´ -->
        <div class="card no-print" style="margin-bottom: var(--spacing-lg); background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid var(--color-primary);">
            <div class="card-body" style="padding: var(--spacing-md);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h4 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-primary); font-size: var(--font-size-lg);">ğŸ“– ìŠ¹ì§„ ì†Œìš” ì—°í•œ (êµì›ì¸ì‚¬ê·œì • ì œ15ì¡°)</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md); font-size: var(--font-size-sm);">
                            <div>
                                <strong>ì •ë…„íŠ¸ë™ (2012.2.28 ì´ì „)</strong><br>
                                ì¡°êµìˆ˜â†’ë¶€êµìˆ˜: 4ë…„<br>
                                ë¶€êµìˆ˜â†’êµìˆ˜: 5ë…„
                            </div>
                            <div>
                                <strong>ì •ë…„íŠ¸ë™ (2012.3.1 ì´í›„)</strong><br>
                                ì¡°êµìˆ˜â†’ë¶€êµìˆ˜: 6ë…„<br>
                                ë¶€êµìˆ˜â†’êµìˆ˜: <span style="color: var(--color-danger); font-weight: 600;">8ë…„ (ìì²´ê¸°ì¤€)</span>
                            </div>
                            <div>
                                <strong>ë¹„ì •ë…„íŠ¸ë™ (2021.4.06 ì‹ ì„¤)</strong><br>
                                ì¡°êµìˆ˜â†’ë¶€êµìˆ˜: 6ë…„<br>
                                <small style="color: var(--text-secondary);">â€» íœ´ì§ê¸°ê°„ ë¯¸ë°˜ì˜ (ì„ìš©ê³„ì•½ ê¸°ë°˜)</small>
                            </div>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.parentElement.style.display='none'" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
                </div>
            </div>
        </div>

        <!-- ê¸°ì¤€ ë‚ ì§œ ë° ë‹¤ìŒ ìŠ¹ì§„ ì •ë³´ -->
        <div class="date-control-section no-print">
            <div class="date-selector">
                <label for="baseDate" class="form-label mb-0">ê¸°ì¤€ ë‚ ì§œ:</label>
                <input type="date" id="baseDate" class="form-control" style="width: auto;">
                <button class="btn btn-secondary btn-sm" onclick="setToday()">ì˜¤ëŠ˜</button>
                <a href="promotion-process.html" class="btn btn-outline btn-sm">ğŸ“‹ í”„ë¡œì„¸ìŠ¤ ë³´ê¸°</a>
            </div>
            <div class="next-promotion-info" id="nextPromotionInfo">
                ê¸°ì¤€ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid no-print">
            <div class="stat-card">
                <div class="stat-number" id="aprilCount">-</div>
                <div class="stat-label">4ì›” ìŠ¹ì§„ ëŒ€ìƒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="octoberCount">-</div>
                <div class="stat-label">10ì›” ìŠ¹ì§„ ëŒ€ìƒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="urgentCount">-</div>
                <div class="stat-label">ë§ˆê° ì„ë°• (D-30)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCount">-</div>
                <div class="stat-label">ì „ì²´ ëŒ€ìƒì</div>
            </div>
        </div>

        <!-- íƒ­ UI -->
        <div class="tabs-container">
            <div class="tabs-nav no-print">
                <button class="tab-button active" onclick="switchTab('candidates')">ğŸ“‹ ìŠ¹ì§„ ëŒ€ìƒì ëª©ë¡</button>
                <button class="tab-button" onclick="switchTab('exceptions')">âš™ï¸ ì˜ˆì™¸ ì‚¬í•­ ê´€ë¦¬</button>
                <button class="tab-button" onclick="switchTab('discipline')">âš–ï¸ ì§•ê³„ì²˜ë¶„ ê´€ë¦¬</button>
                <button class="tab-button" onclick="switchTab('special')">â­ íŠ¹ë³„ ê´€ë¦¬ ëŒ€ìƒ (ìŠ¹ì§„)</button>
            </div>

            <!-- íƒ­1: ìŠ¹ì§„ ëŒ€ìƒì ëª©ë¡ -->
            <div id="tab-candidates" class="tab-content active">
                <!-- ê²€ìƒ‰ ë° í•„í„° -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ìŠ¹ì§„ ëŒ€ìƒì ëª©ë¡ (ë‹¹í•´ ì—°ë„)</h3>
                    </div>
                    <div class="card-body">
                        <div class="search-controls no-print">
                            <input type="text" id="searchBox" class="form-control" placeholder="êµì›ëª…, ì†Œì†, ì§ê¸‰ ê²€ìƒ‰..." onkeyup="filterTable()">
                            <div class="filter-buttons">
                                <button class="filter-btn active" onclick="filterByPeriod('all')">ì „ì²´</button>
                                <button class="filter-btn" onclick="filterByPeriod('april')">4ì›” ìŠ¹ì§„</button>
                                <button class="filter-btn" onclick="filterByPeriod('october')">10ì›” ìŠ¹ì§„</button>
                                <button class="filter-btn" onclick="filterByPeriod('urgent')">ë§ˆê° ì„ë°•</button>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="printPromotionList()">ğŸ“„ ì¸ì‡„</button>
                        </div>

                        <div id="promotionGroupsContainer">
                            <div class="empty-state" style="padding: var(--spacing-xl); text-align: center; color: var(--text-muted);">
                                ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- íƒ­2: ì˜ˆì™¸ ì‚¬í•­ ê´€ë¦¬ -->
            <div id="tab-exceptions" class="tab-content">
                <div class="card no-print">
            <div class="card-header">
                <h3 class="card-title">ì˜ˆì™¸ ì‚¬í•­ ê´€ë¦¬</h3>
            </div>
            <div class="card-body">
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                    ì‚¬ì§ì„œ ì œì¶œ, ìŠ¹ì§„ íƒˆë½, íœ´ì§ ë“±ì˜ ì‚¬ìœ ë¡œ ìŠ¹ì§„ ëŒ€ìƒìì—ì„œ ì œì™¸í•  êµì›ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
                </p>

                <!-- ì˜ˆì™¸ ì¶”ê°€ í¼ -->
                <div style="background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label">ì†Œì†í•™ê³¼ *</label>
                        <input type="text" id="exceptionDepartment" class="form-control" placeholder="ì˜ˆ: ê¸°ê³„ê³µí•™ê³¼">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì„±ëª… *</label>
                        <input type="text" id="exceptionName" class="form-control" placeholder="ì˜ˆ: í™ê¸¸ë™">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì˜ˆì™¸ ìœ í˜• *</label>
                        <select id="exceptionType" class="form-control" onchange="togglePromotionDateField()">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="resignation">ì‚¬ì§ì„œ ì œì¶œ (ì˜êµ¬ ì œì™¸)</option>
                            <option value="failed">ìŠ¹ì§„ íƒˆë½ (íŠ¹ì • ìŠ¹ì§„ì¼ë§Œ ì œì™¸)</option>
                            <option value="leave">íœ´ì§ (íŠ¹ì • ìŠ¹ì§„ì¼ë§Œ ì œì™¸)</option>
                            <option value="discipline">ì§•ê³„ (íŠ¹ì • ìŠ¹ì§„ì¼ë§Œ ì œì™¸)</option>
                            <option value="other">ê¸°íƒ€ (ìŠ¹ì§„ì¼ ì„ íƒ ê°€ëŠ¥)</option>
                        </select>
                    </div>
                    <div class="form-group" id="promotionDateGroup" style="display: none;">
                        <label class="form-label">ì ìš© ìŠ¹ì§„ì¼ <span id="promotionDateRequired">*</span></label>
                        <input type="date" id="exceptionPromotionDate" class="form-control">
                        <small id="promotionDateHelp" style="color: var(--text-muted); font-size: var(--font-size-sm);">
                            ì œì™¸í•  íŠ¹ì • ìŠ¹ì§„ì¼ì„ ì§€ì •í•˜ì„¸ìš”. (ì˜ˆ: 2025-10-01)
                        </small>
                        <small id="promotionDateOptional" style="color: var(--text-muted); font-size: var(--font-size-sm); display: none;">
                            ë¹„ì›Œë‘ë©´ ì˜êµ¬ ì œì™¸ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì‚¬ìœ </label>
                        <input type="text" id="exceptionReason" class="form-control" placeholder="ì˜ˆ: ìŠ¹ì§„ì„ìš© ê¸°ê°„ ì „ ì‚¬ì§ì„œ ì œì¶œ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë¹„ê³ </label>
                        <textarea id="exceptionNote" class="form-control" rows="2" placeholder="ì¶”ê°€ ìƒì„¸ ì •ë³´"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addException()">ì˜ˆì™¸ ì‚¬í•­ ì¶”ê°€</button>
                </div>

                <!-- ì¼ê´„ ì‘ì—… ë²„íŠ¼ -->
                <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="deleteExceptionsByType('leave')" style="font-size: var(--font-size-sm);">
                        ğŸ—‘ï¸ íœ´ì§ ì˜ˆì™¸ ì¼ê´„ ì‚­ì œ
                    </button>
                    <button class="btn btn-outline" onclick="deleteExceptionsByType('all')" style="font-size: var(--font-size-sm); color: var(--color-danger); border-color: var(--color-danger);">
                        âš ï¸ ì „ì²´ ì˜ˆì™¸ ì‚­ì œ
                    </button>
                </div>

                <!-- ì˜ˆì™¸ ëª©ë¡ -->
                <div id="exceptionsList">
                    <p class="text-center text-muted p-3">ë“±ë¡ëœ ì˜ˆì™¸ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
            </div>

            <!-- íƒ­3: ì§•ê³„ì²˜ë¶„ ê´€ë¦¬ -->
            <div id="tab-discipline" class="tab-content">
                <div class="card no-print">
                    <div class="card-header">
                        <h3 class="card-title">ì§•ê³„ì²˜ë¶„ ê´€ë¦¬</h3>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                            êµì›ì¸ì‚¬ê·œì • ì œ15ì¡°ì˜2ì— ë”°ë¼ ì§•ê³„ì²˜ë¶„ì„ ë°›ì€ êµì›ì€ ì¼ì • ê¸°ê°„ ìŠ¹ì§„ì´ ì œí•œë©ë‹ˆë‹¤.<br>
                            <strong>ì •ì§: 18ê°œì›”, ê°ë´‰: 12ê°œì›”, ê²¬ì±…: 6ê°œì›”</strong> (ì§•ê³„ ì¢…ë£Œì¼ë¡œë¶€í„°)
                        </p>

                        <!-- ì§•ê³„ ì¶”ê°€ í¼ -->
                        <div style="background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
                                <div class="form-group">
                                    <label class="form-label">ì†Œì†í•™ê³¼ *</label>
                                    <input type="text" id="disciplineDepartment" class="form-control" placeholder="ì˜ˆ: ì²´ìœ¡í•™ê³¼">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ì„±ëª… *</label>
                                    <input type="text" id="disciplineName" class="form-control" placeholder="ì˜ˆ: í™ê¸¸ë™">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ì§•ê³„ ì¢…ë¥˜ *</label>
                                    <select id="disciplineType" class="form-control">
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="suspension">ì •ì§ (ìŠ¹ì§„ì œí•œ 18ê°œì›”)</option>
                                        <option value="salary_reduction">ê°ë´‰ (ìŠ¹ì§„ì œí•œ 12ê°œì›”)</option>
                                        <option value="reprimand">ê²¬ì±… (ìŠ¹ì§„ì œí•œ 6ê°œì›”)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ì§•ê³„ ì‹œì‘ì¼ *</label>
                                    <input type="date" id="disciplineStartDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ì§•ê³„ ì¢…ë£Œì¼ *</label>
                                    <input type="date" id="disciplineEndDate" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ë¹„ê³ </label>
                                <textarea id="disciplineNote" class="form-control" rows="2" placeholder="ì¶”ê°€ ìƒì„¸ ì •ë³´"></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="addDiscipline()">ì§•ê³„ì²˜ë¶„ ë“±ë¡</button>
                        </div>

                        <!-- ì§•ê³„ ëª©ë¡ -->
                        <div id="disciplineList">
                            <p class="text-center text-muted p-3">ë“±ë¡ëœ ì§•ê³„ì²˜ë¶„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- íƒ­4: íŠ¹ë³„ ê´€ë¦¬ ëŒ€ìƒ (ìŠ¹ì§„) -->
            <div id="tab-special" class="tab-content">
                <div class="card no-print">
                    <div class="card-header">
                        <h3 class="card-title">íŠ¹ë³„ ê´€ë¦¬ ëŒ€ìƒ ë“±ë¡ (ìŠ¹ì§„)</h3>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                            ìŠ¹ì§„ ê´€ë ¨ ë³µì¡í•œ ìƒí™©ì˜ êµì›ì„ ë“±ë¡í•©ë‹ˆë‹¤. ë°œë ¹ì‚¬í•­ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                            <div class="form-group">
                                <label class="form-label">ì†Œì†í•™ê³¼ *</label>
                                <input type="text" id="specialDepartment" class="form-control" placeholder="ì˜ˆ: ì²´ìœ¡í•™ê³¼">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì„±ëª… *</label>
                                <input type="text" id="specialName" class="form-control" placeholder="ì˜ˆ: í™ê¸¸ë™">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì˜ˆìƒ ì²˜ë¦¬ ì‹œê¸°</label>
                                <input type="text" id="specialExpectedDate" class="form-control" placeholder="ì˜ˆ: 2025ë…„ 10ì›”">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: #e3f2fd; border-radius: var(--radius-sm);">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">ìŠ¹ì§„ ì˜ˆì • ì‹œì‘ì¼</label>
                                <input type="date" id="expectedStartDate" class="form-control">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label">ì˜ˆì • ì¢…ë£Œì¼ (ë¯¸ì…ë ¥ì‹œ 6ë…„ ìë™ê³„ì‚°)</label>
                                <input type="date" id="expectedEndDate" class="form-control">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addSpecialRecord('promotion')">íŠ¹ë³„ ê´€ë¦¬ ëŒ€ìƒ ë“±ë¡</button>
                    </div>
                </div>

                <!-- íŠ¹ë³„ ê´€ë¦¬ ëª©ë¡ -->
                <div id="specialList">
                    <div class="empty-state">ë“±ë¡ëœ íŠ¹ë³„ ê´€ë¦¬ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>

        <!-- ì¸ì‡„ìš© í—¤ë” (í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€) -->
        <div class="print-only print-header">
            <h1>ìŠ¹ì§„ ì‹¬ì‚¬ ëŒ€ìƒì ëª…ë‹¨</h1>
            <div class="print-info">
                <p>ê¸°ì¤€ì¼: <span id="printBaseDate"></span></p>
                <p>ìŠ¹ì§„ì˜ˆì •ì¼: <span id="printPromotionDate"></span></p>
            </div>
        </div>

        <!-- ì¸ì‡„ìš© í‘¸í„° (í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€) -->
        <div class="print-only print-footer">
            <p>ë°œí–‰ì¼: <span id="printDate"></span></p>
            <p>ë°œí–‰: êµë¬´ì²˜</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/promotion-engine.js"></script>
    <script src="js/special-management.js"></script>
    <script>
        let facultyData = [];
        let promotionCandidates = [];
        let filteredCandidates = [];
        let currentBaseDate = new Date();
        let promotionEngine = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
            if (localStorage.getItem('specialCaseRecords') && !localStorage.getItem('specialManagementRecords')) {
                SpecialManagement.migrateOldData();
            }
            setToday();
            loadExceptionsList();
            loadDisciplineList();
            loadSpecialList();
        });

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
        function setToday() {
            currentBaseDate = new Date();
            document.getElementById('baseDate').value = DateUtils.formatDateForInput(currentBaseDate);
            updatePromotionEngine();
        }

        // ê¸°ì¤€ ë‚ ì§œ ë³€ê²½
        document.getElementById('baseDate')?.addEventListener('change', function(e) {
            if (e.target.value) {
                const parts = e.target.value.split('-');
                currentBaseDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                updatePromotionEngine();
            }
        });

        // ìŠ¹ì§„ ì—”ì§„ ì—…ë°ì´íŠ¸
        function updatePromotionEngine() {
            promotionEngine = new PromotionEngine(currentBaseDate);
            updateNextPromotionInfo();

            if (facultyData.length > 0) {
                calculatePromotions();
            }
        }

        // ë‹¤ìŒ ìŠ¹ì§„ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateNextPromotionInfo() {
            const nextPeriod = promotionEngine.getNextPromotionPeriod();
            const infoElement = document.getElementById('nextPromotionInfo');

            const promotionDateStr = DateUtils.formatDate(nextPeriod.promotionDate);
            const deadlineStr = DateUtils.formatDate(nextPeriod.deadline);
            const daysUntilPromotion = DateUtils.getDaysUntil(nextPeriod.promotionDate, currentBaseDate);
            const daysUntilDeadline = DateUtils.getDaysUntil(nextPeriod.deadline, currentBaseDate);

            infoElement.innerHTML = `
                <div style="display: flex; gap: var(--spacing-xl); flex-wrap: wrap;">
                    <div>
                        <strong>ë‹¤ìŒ ìŠ¹ì§„ì¼:</strong> ${promotionDateStr}
                        <span class="badge badge-primary">${daysUntilPromotion}ì¼ ë‚¨ìŒ</span>
                    </div>
                    <div>
                        <strong>ì„œë¥˜ ë§ˆê°ì¼:</strong> ${deadlineStr}
                        <span class="badge ${daysUntilDeadline <= 30 ? 'badge-danger' : 'badge-secondary'}">
                            ${daysUntilDeadline}ì¼ ë‚¨ìŒ
                        </span>
                    </div>
                </div>
            `;
        }

        // ìŠ¹ì§„ ëŒ€ìƒì ê³„ì‚°
        function calculatePromotions() {
            if (!promotionEngine) {
                promotionEngine = new PromotionEngine(currentBaseDate);
            }

            console.log('ì „ì²´ êµì› ìˆ˜:', facultyData.length);
            promotionCandidates = promotionEngine.calculateAllPromotions(facultyData);
            console.log('ìŠ¹ì§„ ëŒ€ìƒì ìˆ˜:', promotionCandidates.length);

            filteredCandidates = [...promotionCandidates];

            updateStatistics();
            updateTable();
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const stats = promotionEngine.calculateStatistics(promotionCandidates);

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('aprilCount').textContent = stats.aprilCount;
            document.getElementById('octoberCount').textContent = stats.octoberCount;
            document.getElementById('urgentCount').textContent = stats.urgentCount;
        }

        // í…Œì´ë¸” í–‰ ìƒì„± í—¬í¼ í•¨ìˆ˜
        function createTableRow(candidate) {
            const teacher = candidate.teacher;
            const info = candidate.promotionInfo;

            // ìƒíƒœ ë°°ì§€
            let statusBadge = '';
            if (info.daysUntilDeadline !== null && info.daysUntilDeadline <= 30 && info.daysUntilDeadline >= 0) {
                statusBadge = '<span class="badge badge-urgent">ê¸´ê¸‰</span>';
            } else if (info.daysUntilDeadline !== null && info.daysUntilDeadline <= 60) {
                statusBadge = '<span class="badge badge-warning">ì£¼ì˜</span>';
            } else {
                statusBadge = '<span class="badge badge-normal">ì •ìƒ</span>';
            }

            // ì„ìš©ì¼ ê°€ì ¸ì˜¤ê¸°
            const firstAppointmentField = promotionEngine.getTeacherValue(teacher, 'ì „ì„êµì›\nìµœì´ˆì„ìš©ì¼');
            const firstAppointmentDate = DateUtils.parseDate(firstAppointmentField);

            // íœ´ì§ ê¸°ê°„ ê³„ì‚°
            const leaveMonths = promotionEngine.calculateLeaveMonths(teacher);
            const leaveYears = Math.floor(leaveMonths / 12);
            const remainingMonths = leaveMonths % 12;
            let leaveDisplay = '-';
            if (leaveMonths > 0) {
                if (leaveYears > 0 && remainingMonths > 0) {
                    leaveDisplay = `${leaveYears}ë…„ ${remainingMonths}ê°œì›”`;
                } else if (leaveYears > 0) {
                    leaveDisplay = `${leaveYears}ë…„`;
                } else {
                    leaveDisplay = `${remainingMonths}ê°œì›”`;
                }
            }

            // êµì› ID ìƒì„± (ëª¨ë‹¬ìš©)
            const teacherId = `${teacher['ì„±ëª…']}_${teacher['ì†Œì†']}`.replace(/\s/g, '_');

            return `
                <tr>
                    <td><a href="#" onclick="showTeacherDetail('${teacherId}'); return false;" style="color: var(--color-primary); text-decoration: none; font-weight: 500;">${teacher['ì„±ëª…'] || '-'}</a></td>
                    <td>${teacher['ì†Œì†'] || '-'}</td>
                    <td>${info.currentRank || '-'}</td>
                    <td>${DateUtils.formatDate(firstAppointmentDate)}</td>
                    <td>${info.yearsInRank ? info.yearsInRank + 'ë…„' : '-'}</td>
                    <td style="color: ${leaveMonths > 0 ? 'var(--color-warning)' : 'inherit'}; font-weight: ${leaveMonths > 0 ? '600' : 'normal'};">${leaveDisplay}</td>
                    <td>${DateUtils.formatDate(info.nextPromotionDate)}</td>
                    <td>${DateUtils.formatDate(info.submissionDeadline)}</td>
                    <td>${info.daysUntilDeadline !== null ? 'D-' + info.daysUntilDeadline : '-'}</td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        }

        // ê·¸ë£¹ë³„ í…Œì´ë¸” ë Œë”ë§
        function renderGroupTable(candidates, title) {
            if (candidates.length === 0) return '';

            let html = '<div class="subgroup-section">';
            html += `<div class="subgroup-header">${title} (${candidates.length}ëª…)</div>`;
            html += '<div class="table-wrapper">';
            html += '<table class="table">';
            html += `
                <thead>
                    <tr>
                        <th>ì„±ëª…</th>
                        <th>ì†Œì†</th>
                        <th>í˜„ì§ê¸‰</th>
                        <th>ì„ìš©ì¼</th>
                        <th>ì¬ì§ê¸°ê°„</th>
                        <th>íœ´ì§ê¸°ê°„</th>
                        <th>ìŠ¹ì§„ì˜ˆì •ì¼</th>
                        <th>ì„œë¥˜ë§ˆê°</th>
                        <th>D-Day</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody>
            `;

            candidates.forEach(candidate => {
                html += createTableRow(candidate);
            });

            html += '</tbody></table></div></div>';
            return html;
        }

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ê·¸ë£¹ë³„)
        function updateTable() {
            const container = document.getElementById('promotionGroupsContainer');

            if (filteredCandidates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: var(--spacing-xl); text-align: center; color: var(--text-muted);">
                        ${promotionCandidates.length === 0 ? 'ìŠ¹ì§„ ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'}
                    </div>
                `;
                return;
            }

            // ê·¸ë£¹í™”
            const stats = promotionEngine.calculateStatistics(filteredCandidates);
            let html = '';

            // ì‹œê¸°ë³„ë¡œ ê·¸ë£¹í™”
            ['april', 'october'].forEach(period => {
                const periodCandidates = stats.groups[period];
                if (periodCandidates.length === 0) return;

                const periodGroups = promotionEngine.groupByTrackAndPath(periodCandidates);
                const periodLabel = period === 'april' ? '4ì›” ìŠ¹ì§„ ëŒ€ìƒì' : '10ì›” ìŠ¹ì§„ ëŒ€ìƒì';

                html += '<div class="promotion-group">';
                html += `<div class="group-header">${periodLabel}</div>`;

                // ì •ë…„íŠ¸ë™ ì „ì„êµì›
                if (periodGroups.tenure.associateToFull.length > 0 || periodGroups.tenure.assistantToAssociate.length > 0) {
                    html += '<h4 style="font-size: var(--font-size-lg); font-weight: 600; margin: var(--spacing-md) 0;">ì •ë…„íŠ¸ë™ ì „ì„êµì›</h4>';

                    // ë¶€êµìˆ˜ -> êµìˆ˜
                    html += renderGroupTable(periodGroups.tenure.associateToFull, 'â–¸ ë¶€êµìˆ˜ â†’ êµìˆ˜');

                    // ì¡°êµìˆ˜ -> ë¶€êµìˆ˜
                    html += renderGroupTable(periodGroups.tenure.assistantToAssociate, 'â–¸ ì¡°êµìˆ˜ â†’ ë¶€êµìˆ˜');
                }

                // ë¹„ì •ë…„íŠ¸ë™ ì „ì„êµì›
                if (periodGroups.nonTenure.assistantToAssociate.length > 0) {
                    html += '<h4 style="font-size: var(--font-size-lg); font-weight: 600; margin: var(--spacing-md) 0;">ë¹„ì •ë…„íŠ¸ë™ ì „ì„êµì›</h4>';
                    html += renderGroupTable(periodGroups.nonTenure.assistantToAssociate, 'â–¸ ì¡°êµìˆ˜ â†’ ë¶€êµìˆ˜');
                }

                html += '</div>';
            });

            container.innerHTML = html;
        }

        // ê²€ìƒ‰ í•„í„°
        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            filteredCandidates = promotionCandidates.filter(candidate => {
                const teacher = candidate.teacher;
                const name = (teacher['ì„±ëª…'] || '').toLowerCase();
                const department = (teacher['ì†Œì†'] || '').toLowerCase();
                const rank = (teacher['ì§ê¸‰'] || '').toLowerCase();

                return name.includes(searchTerm) ||
                       department.includes(searchTerm) ||
                       rank.includes(searchTerm);
            });

            updateTable();
        }

        // ìŠ¹ì§„ ì‹œê¸°ë³„ í•„í„°
        function filterByPeriod(period) {
            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (period === 'all') {
                filteredCandidates = [...promotionCandidates];
            } else if (period === 'urgent') {
                filteredCandidates = promotionCandidates.filter(candidate => {
                    const daysUntilDeadline = candidate.promotionInfo.daysUntilDeadline;
                    return daysUntilDeadline !== null && daysUntilDeadline <= 30 && daysUntilDeadline >= 0;
                });
            } else {
                const stats = promotionEngine.calculateStatistics(promotionCandidates);
                filteredCandidates = stats.groups[period] || [];
            }

            updateTable();
        }

        // ì¸ì‡„
        function printPromotionList() {
            // ì¸ì‡„ìš© ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('printBaseDate').textContent = DateUtils.formatDate(currentBaseDate);

            const nextPeriod = promotionEngine.getNextPromotionPeriod();
            document.getElementById('printPromotionDate').textContent = DateUtils.formatDate(nextPeriod.promotionDate);
            document.getElementById('printDate').textContent = DateUtils.formatDate(new Date());

            // ì¸ì‡„
            window.print();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë³µì›
        window.addEventListener('load', () => {
            const savedData = StorageUtils.get('facultyData');
            if (savedData) {
                facultyData = savedData;
                calculatePromotions();
            }
        });

        // ===== ì˜ˆì™¸ ì‚¬í•­ ê´€ë¦¬ í•¨ìˆ˜ =====

        // ì˜ˆì™¸ ìœ í˜•ì— ë”°ë¼ ìŠ¹ì§„ì¼ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        function togglePromotionDateField() {
            const type = document.getElementById('exceptionType').value;
            const promotionDateGroup = document.getElementById('promotionDateGroup');
            const promotionDateInput = document.getElementById('exceptionPromotionDate');
            const requiredSpan = document.getElementById('promotionDateRequired');
            const helpText = document.getElementById('promotionDateHelp');
            const optionalText = document.getElementById('promotionDateOptional');

            if (type === 'failed' || type === 'leave' || type === 'discipline') {
                // ìŠ¹ì§„ íƒˆë½, íœ´ì§, ì§•ê³„: ìŠ¹ì§„ì¼ í•„ìˆ˜
                promotionDateGroup.style.display = 'block';
                promotionDateInput.required = true;
                requiredSpan.style.display = 'inline';
                helpText.style.display = 'block';
                optionalText.style.display = 'none';
            } else if (type === 'other') {
                // ê¸°íƒ€: ìŠ¹ì§„ì¼ ì„ íƒ ê°€ëŠ¥ (ë¹„ì›Œë‘ë©´ ì˜êµ¬ ì œì™¸)
                promotionDateGroup.style.display = 'block';
                promotionDateInput.required = false;
                requiredSpan.style.display = 'none';
                helpText.style.display = 'none';
                optionalText.style.display = 'block';
            } else {
                // ì‚¬ì§: ìŠ¹ì§„ì¼ ë¶ˆí•„ìš” (ì˜êµ¬ ì œì™¸)
                promotionDateGroup.style.display = 'none';
                promotionDateInput.required = false;
                promotionDateInput.value = '';
            }
        }

        // ì˜ˆì™¸ ìœ í˜• í•œê¸€ ë ˆì´ë¸”
        function getExceptionTypeLabel(type) {
            const labels = {
                'resignation': 'ì‚¬ì§ì„œ ì œì¶œ',
                'failed': 'ìŠ¹ì§„ íƒˆë½',
                'leave': 'íœ´ì§',
                'discipline': 'ì§•ê³„',
                'other': 'ê¸°íƒ€'
            };
            return labels[type] || type;
        }

        // ì˜ˆì™¸ ì‚¬í•­ ì¶”ê°€
        function addException() {
            const department = document.getElementById('exceptionDepartment').value.trim();
            const name = document.getElementById('exceptionName').value.trim();
            const type = document.getElementById('exceptionType').value;
            const promotionDate = document.getElementById('exceptionPromotionDate').value;
            const reason = document.getElementById('exceptionReason').value.trim();
            const note = document.getElementById('exceptionNote').value.trim();

            // í•„ìˆ˜ í•­ëª© ê²€ì¦
            if (!department) {
                alert('ì†Œì†í•™ê³¼ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                document.getElementById('exceptionDepartment').focus();
                return;
            }

            if (!name) {
                alert('ì„±ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
                document.getElementById('exceptionName').focus();
                return;
            }

            if (!type) {
                alert('ì˜ˆì™¸ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.');
                document.getElementById('exceptionType').focus();
                return;
            }

            // ìŠ¹ì§„ íƒˆë½, íœ´ì§, ì§•ê³„ì˜ ê²½ìš° ìŠ¹ì§„ì¼ í•„ìˆ˜
            if ((type === 'failed' || type === 'leave' || type === 'discipline') && !promotionDate) {
                alert('ì ìš© ìŠ¹ì§„ì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                document.getElementById('exceptionPromotionDate').focus();
                return;
            }

            // ì˜ˆì™¸ ê°ì²´ ìƒì„±
            const exception = {
                department: department,
                name: name,
                type: type,
                promotionDate: promotionDate || null,  // íŠ¹ì • ìŠ¹ì§„ì¼ (ë˜ëŠ” null = ì˜êµ¬ ì œì™¸)
                reason: reason || '',
                note: note || '',
                isActive: true,
                addedDate: new Date().toISOString()
            };

            // ê¸°ì¡´ ì˜ˆì™¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const exceptions = promotionEngine.getExceptions();

            // ì¤‘ë³µ í™•ì¸
            const duplicate = exceptions.find(ex =>
                ex.name === name &&
                ex.department === department &&
                ex.isActive
            );

            if (duplicate) {
                if (!confirm(`${name} (${department})ëŠ” ì´ë¯¸ ì˜ˆì™¸ ëª©ë¡ì— ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\nê³„ì† ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }

            // ì¶”ê°€
            exceptions.push(exception);
            promotionEngine.saveExceptions(exceptions);

            // í¼ ì´ˆê¸°í™”
            document.getElementById('exceptionDepartment').value = '';
            document.getElementById('exceptionName').value = '';
            document.getElementById('exceptionType').value = '';
            document.getElementById('exceptionPromotionDate').value = '';
            document.getElementById('exceptionReason').value = '';
            document.getElementById('exceptionNote').value = '';
            document.getElementById('promotionDateGroup').style.display = 'none';

            // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadExceptionsList();

            // ìŠ¹ì§„ ëŒ€ìƒì ì¬ê³„ì‚°
            if (facultyData.length > 0) {
                calculatePromotions();
            }

            alert('ì˜ˆì™¸ ì‚¬í•­ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì˜ˆì™¸ ëª©ë¡ ë¡œë“œ
        function loadExceptionsList() {
            if (!promotionEngine) {
                promotionEngine = new PromotionEngine(currentBaseDate);
            }

            const exceptions = promotionEngine.getExceptions();
            const container = document.getElementById('exceptionsList');

            if (exceptions.length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-3">ë“±ë¡ëœ ì˜ˆì™¸ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">';

            exceptions.forEach((exception, index) => {
                const typeLabel = getExceptionTypeLabel(exception.type);
                const addedDate = new Date(exception.addedDate);
                const dateStr = DateUtils.formatDate(addedDate);

                html += `
                    <div style="background: white; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-md); ${!exception.isActive ? 'opacity: 0.5;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: var(--font-size-lg); margin-bottom: var(--spacing-xs);">
                                    ${exception.name} <span style="color: var(--text-secondary); font-weight: 400; font-size: var(--font-size-sm);">(${exception.department})</span>
                                </div>
                                <div style="margin-bottom: var(--spacing-xs);">
                                    <span class="badge badge-${exception.isActive ? 'primary' : 'secondary'}">${typeLabel}</span>
                                    ${exception.promotionDate ? `<span class="badge badge-warning">${exception.promotionDate} ì œì™¸</span>` : '<span class="badge badge-danger">ì˜êµ¬ ì œì™¸</span>'}
                                    ${!exception.isActive ? '<span class="badge badge-secondary">ë¹„í™œì„±</span>' : ''}
                                </div>
                                ${exception.reason ? `<div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">ì‚¬ìœ : ${exception.reason}</div>` : ''}
                                ${exception.note ? `<div style="color: var(--text-muted); font-size: var(--font-size-sm);">ë¹„ê³ : ${exception.note}</div>` : ''}
                                <div style="color: var(--text-muted); font-size: var(--font-size-xs); margin-top: var(--spacing-xs);">ë“±ë¡ì¼: ${dateStr}</div>
                            </div>
                            <div style="display: flex; gap: var(--spacing-xs);">
                                <button class="btn btn-sm btn-outline" onclick="editException(${index})" title="ìˆ˜ì •">
                                    âœï¸
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="toggleException(${index})" title="${exception.isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}">
                                    ${exception.isActive ? 'â¸ï¸' : 'â–¶ï¸'}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteException(${index})" title="ì‚­ì œ">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ì˜ˆì™¸ ì‚­ì œ
        function deleteException(index) {
            const exceptions = promotionEngine.getExceptions();
            const exception = exceptions[index];

            if (!confirm(`${exception.name} (${exception.department})ì˜ ì˜ˆì™¸ ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            exceptions.splice(index, 1);
            promotionEngine.saveExceptions(exceptions);

            loadExceptionsList();

            // ìŠ¹ì§„ ëŒ€ìƒì ì¬ê³„ì‚°
            if (facultyData.length > 0) {
                calculatePromotions();
            }
        }

        // ì˜ˆì™¸ ìˆ˜ì •
        let editingExceptionIndex = null;

        function editException(index) {
            const exceptions = promotionEngine.getExceptions();
            const exception = exceptions[index];

            // í¼ì— ê¸°ì¡´ ê°’ ì±„ìš°ê¸°
            document.getElementById('exceptionDepartment').value = exception.department || '';
            document.getElementById('exceptionName').value = exception.name || '';
            document.getElementById('exceptionType').value = exception.type || '';
            document.getElementById('exceptionReason').value = exception.reason || '';
            document.getElementById('exceptionNote').value = exception.note || '';

            // ìŠ¹ì§„ì¼ í•„ë“œ í‘œì‹œ
            togglePromotionDateField();

            // ìŠ¹ì§„ì¼ ê°’ ì„¤ì •
            if (exception.promotionDate) {
                document.getElementById('exceptionPromotionDate').value = exception.promotionDate;
            }

            // ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
            editingExceptionIndex = index;

            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const addBtn = document.querySelector('#tab-exceptions .btn-primary');
            addBtn.textContent = 'ì˜ˆì™¸ ì‚¬í•­ ìˆ˜ì •';
            addBtn.onclick = saveEditedException;

            // ì·¨ì†Œ ë²„íŠ¼ ì¶”ê°€
            if (!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'cancelEditBtn';
                cancelBtn.className = 'btn btn-outline';
                cancelBtn.textContent = 'ì·¨ì†Œ';
                cancelBtn.style.marginLeft = 'var(--spacing-sm)';
                cancelBtn.onclick = cancelEdit;
                addBtn.parentNode.appendChild(cancelBtn);
            }

            // í¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('exceptionDepartment').focus();
        }

        function saveEditedException() {
            if (editingExceptionIndex === null) return;

            const department = document.getElementById('exceptionDepartment').value.trim();
            const name = document.getElementById('exceptionName').value.trim();
            const type = document.getElementById('exceptionType').value;
            const promotionDate = document.getElementById('exceptionPromotionDate').value;
            const reason = document.getElementById('exceptionReason').value.trim();
            const note = document.getElementById('exceptionNote').value.trim();

            if (!department || !name || !type) {
                alert('ì†Œì†í•™ê³¼, ì„±ëª…, ì˜ˆì™¸ ìœ í˜•ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            // ìŠ¹ì§„ íƒˆë½, íœ´ì§, ì§•ê³„ì˜ ê²½ìš° ìŠ¹ì§„ì¼ í•„ìˆ˜
            if ((type === 'failed' || type === 'leave' || type === 'discipline') && !promotionDate) {
                alert('ì ìš© ìŠ¹ì§„ì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const exceptions = promotionEngine.getExceptions();
            const exception = exceptions[editingExceptionIndex];

            // ê¸°ì¡´ ê°’ ì—…ë°ì´íŠ¸
            exception.department = department;
            exception.name = name;
            exception.type = type;
            exception.promotionDate = promotionDate || null;
            exception.reason = reason;
            exception.note = note;

            promotionEngine.saveExceptions(exceptions);

            // ìˆ˜ì • ëª¨ë“œ ì¢…ë£Œ
            cancelEdit();

            loadExceptionsList();

            // ìŠ¹ì§„ ëŒ€ìƒì ì¬ê³„ì‚°
            if (facultyData.length > 0) {
                calculatePromotions();
            }

            alert('ì˜ˆì™¸ ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function cancelEdit() {
            editingExceptionIndex = null;

            // í¼ ì´ˆê¸°í™”
            document.getElementById('exceptionDepartment').value = '';
            document.getElementById('exceptionName').value = '';
            document.getElementById('exceptionType').value = '';
            document.getElementById('exceptionPromotionDate').value = '';
            document.getElementById('exceptionReason').value = '';
            document.getElementById('exceptionNote').value = '';
            togglePromotionDateField();

            // ë²„íŠ¼ ì›ë˜ëŒ€ë¡œ
            const addBtn = document.querySelector('#tab-exceptions .btn-primary');
            addBtn.textContent = 'ì˜ˆì™¸ ì‚¬í•­ ì¶”ê°€';
            addBtn.onclick = addException;

            // ì·¨ì†Œ ë²„íŠ¼ ì œê±°
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
        }

        // ìœ í˜•ë³„ ì˜ˆì™¸ ì¼ê´„ ì‚­ì œ
        function deleteExceptionsByType(type) {
            const exceptions = promotionEngine.getExceptions();

            if (type === 'all') {
                if (!confirm(`ì „ì²´ ${exceptions.length}ê±´ì˜ ì˜ˆì™¸ ì‚¬í•­ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                    return;
                }
                promotionEngine.saveExceptions([]);
            } else {
                const typeLabels = {
                    'leave': 'íœ´ì§',
                    'resignation': 'ì‚¬ì§',
                    'failed': 'ìŠ¹ì§„ íƒˆë½',
                    'discipline': 'ì§•ê³„'
                };
                const targetCount = exceptions.filter(e => e.type === type).length;

                if (targetCount === 0) {
                    alert(`ì‚­ì œí•  ${typeLabels[type] || type} ì˜ˆì™¸ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                    return;
                }

                if (!confirm(`${typeLabels[type] || type} ìœ í˜•ì˜ ì˜ˆì™¸ ${targetCount}ê±´ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }

                const filtered = exceptions.filter(e => e.type !== type);
                promotionEngine.saveExceptions(filtered);
            }

            loadExceptionsList();

            // ìŠ¹ì§„ ëŒ€ìƒì ì¬ê³„ì‚°
            if (facultyData.length > 0) {
                calculatePromotions();
            }

            alert('ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì˜ˆì™¸ í™œì„±í™”/ë¹„í™œì„±í™” í† ê¸€
        function toggleException(index) {
            const exceptions = promotionEngine.getExceptions();
            exceptions[index].isActive = !exceptions[index].isActive;

            promotionEngine.saveExceptions(exceptions);

            loadExceptionsList();

            // ìŠ¹ì§„ ëŒ€ìƒì ì¬ê³„ì‚°
            if (facultyData.length > 0) {
                calculatePromotions();
            }
        }

        // êµì› ìƒì„¸ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
        function showTeacherDetail(teacherId) {
            // teacherId í˜•ì‹: "ì´ë¦„_í•™ê³¼" (ê³µë°± ì œê±°ë¨)
            const idParts = teacherId.split('_');
            const name = idParts.slice(0, -1).join('_');
            const department = idParts[idParts.length - 1];

            // êµì› ë°ì´í„° ì°¾ê¸°
            const teacher = facultyData.find(t =>
                t['ì„±ëª…'] === name && t['ì†Œì†'] === department
            );

            if (!teacher) {
                alert('êµì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë°œë ¹ì‚¬í•­ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const appointmentHistory = promotionEngine.getAppointmentHistory(teacher);

            // ëª¨ë‹¬ ë‚´ìš© êµ¬ì„±
            const modalBody = document.getElementById('teacherModalBody');
            let html = '';

            // ê¸°ë³¸ ì •ë³´
            html += '<div class="info-section">';
            html += '<h3 class="info-section-title">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>';
            html += '<div class="info-grid">';
            html += `
                <div class="info-item">
                    <div class="info-label">ì„±ëª…</div>
                    <div class="info-value">${teacher['ì„±ëª…'] || '-'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì†Œì†</div>
                    <div class="info-value">${teacher['ì†Œì†'] || '-'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">í˜„ì¬ ì§ê¸‰</div>
                    <div class="info-value">${teacher['ì§ê¸‰'] || '-'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">íŠ¸ë™</div>
                    <div class="info-value">${teacher['íŠ¸ë™'] || '-'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ì„ìš©ì¼</div>
                    <div class="info-value">${teacher['ì„ìš©ì¼'] || '-'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ê³„ì•½ì¢…ë£Œì¼</div>
                    <div class="info-value">${teacher['ê³„ì•½ì¢…ë£Œì¼'] || '-'}</div>
                </div>
            `;
            html += '</div>';

            // ìŠ¹ì§„ ê´€ë ¨ ì •ë³´
            const info = promotionEngine.getPromotionInfo(teacher);
            const leaveMonths = promotionEngine.calculateLeaveMonths(teacher);
            const leaveYears = Math.floor(leaveMonths / 12);
            const remainingMonths = leaveMonths % 12;
            let leaveDisplay = '-';
            if (leaveMonths > 0) {
                if (leaveYears > 0 && remainingMonths > 0) {
                    leaveDisplay = `${leaveYears}ë…„ ${remainingMonths}ê°œì›”`;
                } else if (leaveYears > 0) {
                    leaveDisplay = `${leaveYears}ë…„`;
                } else {
                    leaveDisplay = `${remainingMonths}ê°œì›”`;
                }
            }

            html += '<div style="margin-top: var(--spacing-md);">';
            if (info.yearsInRank) {
                html += `<span class="summary-badge primary">ì¬ì§ê¸°ê°„: ${info.yearsInRank}ë…„</span>`;
            }
            if (leaveMonths > 0) {
                html += `<span class="summary-badge warning">íœ´ì§ê¸°ê°„: ${leaveDisplay}</span>`;
            }
            if (info.nextPromotionDate) {
                html += `<span class="summary-badge info">ìŠ¹ì§„ì˜ˆì •ì¼: ${DateUtils.formatDate(info.nextPromotionDate)}</span>`;
            }
            html += '</div>';
            html += '</div>';

            // ë°œë ¹ì‚¬í•­ íƒ€ì„ë¼ì¸
            if (appointmentHistory && appointmentHistory.appointments && appointmentHistory.appointments.length > 0) {
                html += '<div class="info-section">';
                html += '<h3 class="info-section-title">ğŸ“… ë°œë ¹ì‚¬í•­ ì´ë ¥</h3>';
                html += '<div class="timeline">';

                // ë°œë ¹ì‚¬í•­ì„ ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬
                const sortedAppointments = [...appointmentHistory.appointments].sort((a, b) => {
                    const dateA = promotionEngine.parseDate(a['ë°œë ¹ì¼'] || a['ë°œë ¹ì¼ì'] || a['ë°œë ¹ì‹œì‘ì¼']) || new Date(0);
                    const dateB = promotionEngine.parseDate(b['ë°œë ¹ì¼'] || b['ë°œë ¹ì¼ì'] || b['ë°œë ¹ì‹œì‘ì¼']) || new Date(0);
                    return dateA - dateB;
                });

                sortedAppointments.forEach(record => {
                    const appointmentType = (record['ë°œë ¹êµ¬ë¶„'] || record['ë°œë ¹ì‚¬ìœ '] || '').toString();
                    const appointmentDate = record['ë°œë ¹ì¼'] || record['ë°œë ¹ì¼ì'] || record['ë°œë ¹ì‹œì‘ì¼'];
                    const endDate = record['ë°œë ¹ì¢…ë£Œì¼'];

                    let cssClass = '';
                    let icon = 'ğŸ“‹';

                    // íœ´ì§ ê´€ë ¨
                    if (appointmentType.includes('íœ´ì§')) {
                        cssClass = 'leave';
                        icon = 'â¸ï¸';
                    }
                    // ì¬ì„ìš© ê´€ë ¨
                    else if (appointmentType.includes('ì¬ì„ìš©') || appointmentType.includes('ì¬ê³„ì•½')) {
                        cssClass = 'reappointment';
                        icon = 'ğŸ”„';
                    }
                    // ì„ìš© ê´€ë ¨
                    else if (appointmentType.includes('ì„ìš©')) {
                        icon = 'âœ…';
                    }

                    html += `<div class="timeline-item">`;
                    html += `<div class="timeline-dot ${cssClass}"></div>`;
                    html += `<div class="timeline-content ${cssClass}">`;
                    html += `<div class="timeline-date">${icon} ${appointmentDate ? DateUtils.formatDate(promotionEngine.parseDate(appointmentDate)) : '-'}</div>`;
                    html += `<div class="timeline-title">${appointmentType}</div>`;

                    // ìƒì„¸ ì •ë³´ ì¶”ê°€
                    let description = [];

                    if (endDate) {
                        description.push(`ì¢…ë£Œì¼: ${DateUtils.formatDate(promotionEngine.parseDate(endDate))}`);
                    }

                    // íœ´ì§ ê¸°ê°„ ì •ë³´
                    if (appointmentType.includes('íœ´ì§')) {
                        const leaveYears = parseFloat(record['íœ´ì§ê¸°ê°„(ë…„)']) || 0;
                        const leaveMonths = parseFloat(record['íœ´ì§ê¸°ê°„(ì›”)']) || 0;
                        if (leaveYears > 0 || leaveMonths > 0) {
                            let leavePeriod = '';
                            if (leaveYears > 0) leavePeriod += `${leaveYears}ë…„ `;
                            if (leaveMonths > 0) leavePeriod += `${leaveMonths}ê°œì›”`;
                            description.push(`ê¸°ê°„: ${leavePeriod.trim()}`);
                        }
                    }

                    // ê³„ì•½ ê¸°ê°„ ì •ë³´
                    if (record['ê³„ì•½ê¸°ê°„(ë…„)']) {
                        description.push(`ê³„ì•½: ${record['ê³„ì•½ê¸°ê°„(ë…„)']}ë…„`);
                    }

                    if (description.length > 0) {
                        html += `<p class="timeline-description">${description.join(' | ')}</p>`;
                    }

                    html += `</div></div>`;
                });

                html += '</div>';
                html += '</div>';
            } else {
                html += '<div class="info-section">';
                html += '<h3 class="info-section-title">ğŸ“… ë°œë ¹ì‚¬í•­ ì´ë ¥</h3>';
                html += '<p style="color: var(--text-secondary);">ë°œë ¹ì‚¬í•­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                html += '</div>';
            }

            // ì¬ì„ìš© ì •ë³´ (ë¹„ì •ë…„íŠ¸ë™ì¸ ê²½ìš°)
            if (teacher['íŠ¸ë™'] && teacher['íŠ¸ë™'].includes('ë¹„ì •ë…„')) {
                html += '<div class="info-section">';
                html += '<h3 class="info-section-title">ğŸ”„ ì¬ì„ìš© ì •ë³´</h3>';

                const contractEndDate = teacher['ê³„ì•½ì¢…ë£Œì¼'];
                if (contractEndDate) {
                    const endDate = promotionEngine.parseDate(contractEndDate);
                    const today = new Date();
                    const daysUntilEnd = Math.floor((endDate - today) / (1000 * 60 * 60 * 24));

                    html += '<div class="info-grid">';
                    html += `
                        <div class="info-item">
                            <div class="info-label">ê³„ì•½ì¢…ë£Œì¼</div>
                            <div class="info-value">${DateUtils.formatDate(endDate)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ì”ì—¬ì¼ìˆ˜</div>
                            <div class="info-value" style="color: ${daysUntilEnd < 180 ? 'var(--color-danger)' : 'inherit'}">
                                ${daysUntilEnd > 0 ? 'D-' + daysUntilEnd : 'ê³„ì•½ ë§Œë£Œ'}
                            </div>
                        </div>
                    `;
                    html += '</div>';

                    if (daysUntilEnd < 180 && daysUntilEnd > 0) {
                        html += '<p style="color: var(--color-danger); margin-top: var(--spacing-md);">âš ï¸ ì¬ì„ìš© ì‹¬ì‚¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>';
                    }
                } else {
                    html += '<p style="color: var(--text-secondary);">ê³„ì•½ì¢…ë£Œì¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }

                html += '</div>';
            }

            modalBody.innerHTML = html;

            // ëª¨ë‹¬ íƒ€ì´í‹€ ì„¤ì •
            document.getElementById('teacherModalTitle').textContent = `${teacher['ì„±ëª…']} (${teacher['ì†Œì†']})`;

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('teacherModal').classList.add('active');
        }

        // êµì› ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeTeacherModal() {
            document.getElementById('teacherModal').classList.remove('active');
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('teacherModal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeTeacherModal();
                    }
                });
            }
        });

        // ===== ì§•ê³„ì²˜ë¶„ ê´€ë¦¬ í•¨ìˆ˜ =====

        const DISCIPLINE_KEY = 'disciplineRecords';

        // ì§•ê³„ ì¢…ë¥˜ë³„ ìŠ¹ì§„ ì œí•œ ê¸°ê°„ (ê°œì›”)
        const DISCIPLINE_RESTRICTION_MONTHS = {
            'suspension': 18,      // ì •ì§
            'salary_reduction': 12, // ê°ë´‰
            'reprimand': 6          // ê²¬ì±…
        };

        const DISCIPLINE_LABELS = {
            'suspension': 'ì •ì§',
            'salary_reduction': 'ê°ë´‰',
            'reprimand': 'ê²¬ì±…'
        };

        // ì§•ê³„ ëª©ë¡ ë¡œë“œ
        function loadDisciplineList() {
            const disciplines = getDisciplines();
            const container = document.getElementById('disciplineList');

            if (disciplines.length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-3">ë“±ë¡ëœ ì§•ê³„ì²˜ë¶„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">';

            disciplines.forEach((discipline, index) => {
                const typeLabel = DISCIPLINE_LABELS[discipline.type] || discipline.type;
                const restrictionMonths = DISCIPLINE_RESTRICTION_MONTHS[discipline.type] || 0;
                const endDate = new Date(discipline.endDate);
                const restrictionEndDate = new Date(endDate);
                restrictionEndDate.setMonth(restrictionEndDate.getMonth() + restrictionMonths);

                const today = new Date();
                const isRestricted = today < restrictionEndDate;
                const statusBadge = isRestricted
                    ? '<span class="badge badge-danger">ìŠ¹ì§„ì œí•œ ì¤‘</span>'
                    : '<span class="badge badge-success">ì œí•œ í•´ì œ</span>';

                html += `
                    <div style="background: white; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: var(--font-size-lg); margin-bottom: var(--spacing-xs);">
                                    ${discipline.name} <span style="color: var(--text-secondary); font-weight: 400; font-size: var(--font-size-sm);">(${discipline.department})</span>
                                </div>
                                <div style="margin-bottom: var(--spacing-xs);">
                                    <span class="badge badge-warning">${typeLabel}</span>
                                    ${statusBadge}
                                </div>
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">
                                    ì§•ê³„ê¸°ê°„: ${discipline.startDate} ~ ${discipline.endDate}
                                </div>
                                <div style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--spacing-xs);">
                                    ìŠ¹ì§„ì œí•œ í•´ì œì¼: <strong>${DateUtils.formatDate(restrictionEndDate)}</strong> (ì¢…ë£Œì¼ + ${restrictionMonths}ê°œì›”)
                                </div>
                                ${discipline.note ? `<div style="color: var(--text-muted); font-size: var(--font-size-sm);">ë¹„ê³ : ${discipline.note}</div>` : ''}
                            </div>
                            <div>
                                <button class="btn btn-sm btn-danger" onclick="deleteDiscipline(${index})" title="ì‚­ì œ">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ì§•ê³„ ì¶”ê°€
        function addDiscipline() {
            const department = document.getElementById('disciplineDepartment').value.trim();
            const name = document.getElementById('disciplineName').value.trim();
            const type = document.getElementById('disciplineType').value;
            const startDate = document.getElementById('disciplineStartDate').value;
            const endDate = document.getElementById('disciplineEndDate').value;
            const note = document.getElementById('disciplineNote').value.trim();

            if (!department || !name || !type || !startDate || !endDate) {
                alert('ì†Œì†í•™ê³¼, ì„±ëª…, ì§•ê³„ ì¢…ë¥˜, ì‹œì‘ì¼, ì¢…ë£Œì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            const discipline = {
                department,
                name,
                type,
                startDate,
                endDate,
                note,
                addedDate: new Date().toISOString()
            };

            const disciplines = getDisciplines();
            disciplines.push(discipline);
            saveDisciplines(disciplines);

            // í¼ ì´ˆê¸°í™”
            document.getElementById('disciplineDepartment').value = '';
            document.getElementById('disciplineName').value = '';
            document.getElementById('disciplineType').value = '';
            document.getElementById('disciplineStartDate').value = '';
            document.getElementById('disciplineEndDate').value = '';
            document.getElementById('disciplineNote').value = '';

            loadDisciplineList();

            // ìŠ¹ì§„ ëŒ€ìƒì ì¬ê³„ì‚°
            if (facultyData.length > 0) {
                calculatePromotions();
            }

            alert('ì§•ê³„ì²˜ë¶„ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ì§•ê³„ ì‚­ì œ
        function deleteDiscipline(index) {
            const disciplines = getDisciplines();
            const discipline = disciplines[index];

            if (!confirm(`${discipline.name} (${discipline.department})ì˜ ì§•ê³„ì²˜ë¶„ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            disciplines.splice(index, 1);
            saveDisciplines(disciplines);

            loadDisciplineList();

            // ìŠ¹ì§„ ëŒ€ìƒì ì¬ê³„ì‚°
            if (facultyData.length > 0) {
                calculatePromotions();
            }
        }

        // ì§•ê³„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        function getDisciplines() {
            const stored = localStorage.getItem(DISCIPLINE_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        // ì§•ê³„ ëª©ë¡ ì €ì¥
        function saveDisciplines(disciplines) {
            localStorage.setItem(DISCIPLINE_KEY, JSON.stringify(disciplines));
        }

        // íŠ¹ì • êµì›ì˜ ìŠ¹ì§„ ì œí•œ ì—¬ë¶€ í™•ì¸
        function checkDisciplineRestriction(teacherName, department, promotionDate) {
            const disciplines = getDisciplines();
            const promotionDateObj = new Date(promotionDate);

            for (const discipline of disciplines) {
                // ì´ë¦„ê³¼ ì†Œì†ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                if (discipline.name === teacherName &&
                    (!discipline.department || discipline.department === department)) {

                    const restrictionMonths = DISCIPLINE_RESTRICTION_MONTHS[discipline.type] || 0;
                    const endDate = new Date(discipline.endDate);
                    const restrictionEndDate = new Date(endDate);
                    restrictionEndDate.setMonth(restrictionEndDate.getMonth() + restrictionMonths);

                    // ìŠ¹ì§„ì¼ì´ ì œí•œ í•´ì œì¼ ì´ì „ì´ë©´ ìŠ¹ì§„ ë¶ˆê°€
                    if (promotionDateObj < restrictionEndDate) {
                        return {
                            isRestricted: true,
                            type: DISCIPLINE_LABELS[discipline.type],
                            restrictionEndDate: DateUtils.formatDate(restrictionEndDate)
                        };
                    }
                }
            }

            return { isRestricted: false };
        }

        // ===== íŠ¹ë³„ ê´€ë¦¬ ëŒ€ìƒ í•¨ìˆ˜ =====

        function addSpecialRecord(type) {
            const department = document.getElementById('specialDepartment').value.trim();
            const name = document.getElementById('specialName').value.trim();
            const expectedDate = document.getElementById('specialExpectedDate').value.trim();
            const expectedStartDate = document.getElementById('expectedStartDate').value;
            const expectedEndDate = document.getElementById('expectedEndDate').value;

            if (!department || !name) {
                alert('ì†Œì†í•™ê³¼ì™€ ì„±ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            SpecialManagement.addRecord({
                name, department, type, expectedDate,
                expectedStartDate, expectedEndDate
            });

            // í¼ ì´ˆê¸°í™”
            document.getElementById('specialDepartment').value = '';
            document.getElementById('specialName').value = '';
            document.getElementById('specialExpectedDate').value = '';
            document.getElementById('expectedStartDate').value = '';
            document.getElementById('expectedEndDate').value = '';

            loadSpecialList();
            alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function loadSpecialList() {
            const records = SpecialManagement.getRecordsByType('promotion');
            const container = document.getElementById('specialList');

            if (records.length === 0) {
                container.innerHTML = '<div class="empty-state">ë“±ë¡ëœ íŠ¹ë³„ ê´€ë¦¬ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = '';
            records.forEach(record => {
                html += renderSpecialCard(record);
            });
            container.innerHTML = html;
        }

        function renderSpecialCard(record) {
            // ì˜ˆì •ì¼ ì •ë³´ êµ¬ì„±
            const expectedInfo = record.expectedStartDate ? {
                startDate: record.expectedStartDate,
                endDate: record.expectedEndDate || null,
                type: record.type
            } : null;

            const tableData = SpecialManagement.buildTableData(record.name, record.department, currentBaseDate, expectedInfo);

            let tableHtml = '';
            if (tableData.rows.length > 0) {
                tableHtml = `
                    <table class="special-table">
                        <thead>
                            <tr>
                                <th>ë°œë ¹ì‹œì‘ì¼</th>
                                <th>ë°œë ¹ì¢…ë£Œì¼</th>
                                <th>ë°œë ¹êµ¬ë¶„</th>
                                <th>ê¸°ê°„</th>
                                <th>ìŠ¹ì§„ countdown</th>
                                <th>ì¬ì„ìš© countdown</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                tableData.rows.forEach(row => {
                    let rowClass = '';
                    if (row.category === 'leave') rowClass = 'leave-row';
                    else if (row.category === 'return') rowClass = 'return-row';
                    else if (row.category === 'sick') rowClass = 'sick-row';
                    else if (row.isExpected) rowClass = 'expected-row';
                    else if (row.isCurrent) rowClass = 'current-row';

                    tableHtml += `
                        <tr class="${rowClass}">
                            <td>${row.startDate}</td>
                            <td>${row.endDate}</td>
                            <td>${row.type}</td>
                            <td>${row.duration}</td>
                            <td>${row.promotionCountdown}</td>
                            <td>${row.reappointmentCountdown}</td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table>';
            } else {
                tableHtml = '<div class="empty-state">ë°œë ¹ì‚¬í•­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„° ê´€ë¦¬ì—ì„œ ë°œë ¹ì‚¬í•­ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>';
            }

            return `
                <div class="special-card">
                    <div class="special-card-header">
                        <h4>${record.name} (${record.department})</h4>
                        <span class="badge">ìŠ¹ì§„ ê´€ë ¨ ${record.expectedDate ? '| ì˜ˆìƒ: ' + record.expectedDate : ''}</span>
                    </div>
                    <div class="special-card-body">
                        ${tableHtml}
                        <div class="special-actions">
                            <button class="btn btn-sm btn-outline" onclick="editSpecialRecord('${record.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSpecialRecord('${record.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function deleteSpecialRecord(id) {
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            SpecialManagement.deleteRecord(id);
            loadSpecialList();
        }

        function editSpecialRecord(id) {
            const records = SpecialManagement.getRecords();
            const record = records.find(r => r.id === id);
            if (!record) return;

            const newExpected = prompt('ì˜ˆìƒ ì²˜ë¦¬ ì‹œê¸°:', record.expectedDate || '');
            const newConclusion = prompt('ê²°ë¡ /ì¡°ì¹˜ì‚¬í•­:', record.conclusion || '');

            if (newExpected !== null || newConclusion !== null) {
                SpecialManagement.updateRecord(id, {
                    expectedDate: newExpected || record.expectedDate,
                    conclusion: newConclusion || record.conclusion
                });
                loadSpecialList();
            }
        }
    </script>

    <!-- êµì› ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div id="teacherModal" class="teacher-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="teacherModalTitle">êµì› ìƒì„¸ ì •ë³´</h2>
                <button class="modal-close" onclick="closeTeacherModal()" aria-label="ë‹«ê¸°">&times;</button>
            </div>
            <div class="modal-body" id="teacherModalBody">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>
    </div>
</body>
</html>
