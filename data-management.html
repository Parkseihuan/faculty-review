<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„° ê´€ë¦¬ - êµì› ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/navigation.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .page-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-xl) 0;
            margin-bottom: var(--spacing-xl);
        }

        .page-title {
            font-size: var(--font-size-3xl);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .upload-section {
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
            margin-bottom: var(--spacing-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-section:hover {
            border-color: var(--color-primary);
            background: var(--bg-secondary);
        }

        .upload-section.drag-over {
            border-color: var(--color-primary);
            background: var(--bg-secondary);
        }

        .upload-section input {
            display: none;
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        .upload-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .upload-description {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .file-info {
            display: none;
            background: var(--bg-secondary);
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-md);
        }

        .file-info.show {
            display: block;
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-box {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            text-align: center;
        }

        .stat-number {
            font-size: var(--font-size-stat);
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .data-preview {
            margin-top: var(--spacing-xl);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            max-height: 500px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        @media (max-width: 768px) {
            .upload-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">êµì› ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            <button class="navbar-toggle" aria-label="ë©”ë‰´ í† ê¸€">
                <span class="navbar-toggle-icon"></span>
            </button>
            <ul class="navbar-menu">
                <li class="navbar-item">
                    <a href="index.html" class="navbar-link" data-page="dashboard">ëŒ€ì‹œë³´ë“œ</a>
                </li>
                <li class="navbar-item">
                    <a href="promotion.html" class="navbar-link" data-page="promotion">ìŠ¹ì§„</a>
                </li>
                <li class="navbar-item">
                    <a href="reappointment.html" class="navbar-link" data-page="reappointment">ì¬ì„ìš©</a>
                </li>
                <li class="navbar-item">
                    <a href="data-management.html" class="navbar-link" data-page="data">ë°ì´í„° ê´€ë¦¬</a>
                </li>
                <li class="navbar-item">
                    <a href="process.html" class="navbar-link" data-page="process">í”„ë¡œì„¸ìŠ¤ & ê·œì •</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header">
        <div class="container">
            <h1 class="page-title">ë°ì´í„° ê´€ë¦¬</h1>
            <p class="section-subtitle">êµì›í˜„í™© ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>
    </div>

    <div class="container">
        <!-- íŒŒì¼ ì—…ë¡œë“œ ê·¸ë¦¬ë“œ -->
        <div class="upload-grid">
            <!-- êµì›í˜„í™© íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š êµì›í˜„í™© ë°ì´í„°</h3>
                </div>
                <div class="card-body">
                    <div class="upload-section" id="uploadSection">
                        <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="loadExcelFile(event)">
                        <div class="upload-icon">ğŸ“Š</div>
                        <h3 class="upload-title">êµì›í˜„í™© ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>
                        <p class="upload-description">
                            í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”<br>
                            <small>(ì§€ì› í˜•ì‹: .xlsx, .xls)</small>
                        </p>
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            íŒŒì¼ ì„ íƒ
                        </button>
                        <div class="file-info" id="fileInfo">
                            <strong id="fileName"></strong> - <span id="fileSize"></span>
                        </div>
                    </div>

                    <!-- ë¶„ì„ ê²°ê³¼ -->
                    <div id="facultyAnalysisResult" style="display: none; margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <h4 style="margin-bottom: var(--spacing-sm);">ë¶„ì„ ê²°ê³¼</h4>
                        <div id="facultyAnalysisContent"></div>
                    </div>
                </div>
            </div>

            <!-- ë°œë ¹ì‚¬í•­ íŒŒì¼ ì—…ë¡œë“œ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“‹ êµì› ë°œë ¹ì‚¬í•­ í˜„í™©</h3>
                </div>
                <div class="card-body">
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-sm); font-size: var(--font-size-sm);">
                        ë°œë ¹ì‚¬í•­ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì‚¬ì§, íœ´ì§, ì§•ê³„ ë“±ì˜ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ìŠ¹ì§„ ì˜ˆì™¸ ì‚¬í•­ì— ë“±ë¡í•©ë‹ˆë‹¤.
                    </p>
                    <div class="upload-section" id="appointmentUploadSection" style="margin-bottom: 0;">
                        <input type="file" id="appointmentFileInput" accept=".xlsx,.xls" onchange="loadAppointmentFile(event)">
                        <div class="upload-icon">ğŸ“‹</div>
                    <h3 class="upload-title">ë°œë ¹ì‚¬í•­ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>
                    <p class="upload-description">
                        í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”<br>
                        <small>(ì§€ì› í˜•ì‹: .xlsx, .xls)</small>
                    </p>
                    <button class="btn btn-primary" onclick="document.getElementById('appointmentFileInput').click()">
                        íŒŒì¼ ì„ íƒ
                    </button>
                    <div class="file-info" id="appointmentFileInfo">
                        <strong id="appointmentFileName"></strong> - <span id="appointmentFileSize"></span>
                    </div>
                </div>

                <!-- ë¶„ì„ ê²°ê³¼ -->
                <div id="appointmentAnalysisResult" style="display: none; margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md);">
                    <h4 style="margin-bottom: var(--spacing-sm);">ë¶„ì„ ê²°ê³¼</h4>
                    <div id="appointmentAnalysisContent"></div>
                </div>
            </div>
            </div>
        </div>

        <!-- ë°ì´í„° í†µê³„ -->
        <div class="stats-section" id="statsSection" style="display: none;">
            <div class="stat-box">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">ì „ì²´ êµì›</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="tenureCount">0</div>
                <div class="stat-label">ì •ë…„íŠ¸ë™</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="nonTenureCount">0</div>
                <div class="stat-label">ë¹„ì •ë…„íŠ¸ë™</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="professorCount">0</div>
                <div class="stat-label">êµìˆ˜</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="associateCount">0</div>
                <div class="stat-label">ë¶€êµìˆ˜</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="assistantCount">0</div>
                <div class="stat-label">ì¡°êµìˆ˜</div>
            </div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="card" id="actionCard" style="display: none;">
            <div class="card-body">
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="clearData()">
                        ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”
                    </button>
                    <button class="btn btn-outline" onclick="exportData()">
                        ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸° <span class="coming-soon-badge" style="display: inline-block; padding: 2px 6px; background: var(--color-warning); color: var(--text-primary); border-radius: var(--radius-sm); font-size: 0.75rem; margin-left: 4px;">ì¤€ë¹„ì¤‘</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
        <div class="data-preview" id="dataPreview" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="searchBox" placeholder="êµì›ëª…, ì†Œì†, ì§ê¸‰ ê²€ìƒ‰..." onkeyup="filterTable()">
                    </div>
                    <div class="table-wrapper">
                        <table class="table" id="dataTable">
                            <thead>
                                <tr>
                                    <th>ì„±ëª…</th>
                                    <th>ì†Œì†</th>
                                    <th>ì§ê¸‰</th>
                                    <th>ì„ìš©ì¼</th>
                                    <th>ì¬ì„ìš©ì‹œì‘ì¼</th>
                                    <th>ì¢…ë£Œì¼</th>
                                    <th>ì¬ì§êµ¬ë¶„</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr>
                                    <td colspan="7" class="empty-state">
                                        ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/promotion-engine.js"></script>
    <script>
        let facultyData = [];
        let filteredData = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë³µì›
        document.addEventListener('DOMContentLoaded', function() {
            // ì €ì¥ëœ êµì›í˜„í™© ë°ì´í„° ë¡œë“œ
            const savedData = StorageUtils.get('facultyData');
            if (savedData && savedData.length > 0) {
                facultyData = savedData;
                filteredData = [...facultyData];
                updateUI();
                showSavedDataStatus('faculty', savedData.length);
            }

            // ì €ì¥ëœ ë°œë ¹ì‚¬í•­ ë°ì´í„° ìƒíƒœ í‘œì‹œ
            const savedAppointmentData = StorageUtils.get('appointmentData');
            if (savedAppointmentData && savedAppointmentData.length > 0) {
                showSavedDataStatus('appointment', savedAppointmentData.length);
            }
        });

        // ì €ì¥ëœ ë°ì´í„° ìƒíƒœ í‘œì‹œ
        function showSavedDataStatus(type, count) {
            if (type === 'faculty') {
                const resultDiv = document.getElementById('facultyAnalysisResult');
                const contentDiv = document.getElementById('facultyAnalysisContent');

                contentDiv.innerHTML = `
                    <div style="padding: var(--spacing-sm); background: var(--bg-primary); border-radius: var(--radius-sm); color: var(--text-secondary);">
                        âœ“ ì´ì „ì— ì—…ë¡œë“œí•œ êµì›í˜„í™© ë°ì´í„° <strong>${count.toLocaleString()}ëª…</strong>ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                        <br><small style="color: var(--text-muted);">ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ê°€ êµì²´ë©ë‹ˆë‹¤.</small>
                    </div>
                `;
                resultDiv.style.display = 'block';
            } else if (type === 'appointment') {
                const resultDiv = document.getElementById('appointmentAnalysisResult');
                const contentDiv = document.getElementById('appointmentAnalysisContent');

                contentDiv.innerHTML = `
                    <div style="padding: var(--spacing-sm); background: var(--bg-primary); border-radius: var(--radius-sm); color: var(--text-secondary);">
                        âœ“ ì´ì „ì— ì—…ë¡œë“œí•œ ë°œë ¹ì‚¬í•­ ë°ì´í„° <strong>${count.toLocaleString()}ê±´</strong>ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                        <br><small style="color: var(--text-muted);">ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ê°€ êµì²´ë©ë‹ˆë‹¤.</small>
                    </div>
                `;
                resultDiv.style.display = 'block';
            }
        }

        // í—¤ë”ëª… ì •ê·œí™”
        function getTeacherValue(teacher, fieldName) {
            const possibleKeys = [
                fieldName,
                fieldName.replace(/\r?\n/g, ''),
                fieldName.replace(/\r?\n/g, '\r\n'),
                fieldName.replace(/\r?\n/g, '\n')
            ];

            for (const key of possibleKeys) {
                if (teacher[key] !== undefined && teacher[key] !== null) {
                    return teacher[key];
                }
            }
            return null;
        }

        // ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        async function loadExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            // íŒŒì¼ ì •ë³´ í‘œì‹œ
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');

            fileName.textContent = file.name;
            fileSize.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
            fileInfo.classList.add('show');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    // í—¤ë” ì°¾ê¸°
                    let headerRowIndex = -1;
                    let headers = [];

                    for (let i = 0; i < rawData.length; i++) {
                        if (rawData[i] && rawData[i][0] === 'No.' && rawData[i].includes('ì„±ëª…')) {
                            headerRowIndex = i;
                            headers = rawData[i];
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        throw new Error('í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. êµì›í˜„í™© ì—‘ì…€ íŒŒì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }

                    // ë°ì´í„° ì¶”ì¶œ
                    const actualDataRows = rawData.slice(headerRowIndex + 1).filter(row =>
                        row && row.length > 0 && row[0] && typeof row[0] === 'number'
                    );

                    // ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
                    const jsonData = actualDataRows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index];
                        });
                        return obj;
                    });

                    // ì¬ì§ì¤‘ì¸ ì „ì„êµì›ë§Œ í•„í„°ë§ (ì—°êµ¬ë…„, íœ´ì§ ë“± í¬í•¨, í‡´ì§ì ì œì™¸)
                    facultyData = jsonData.filter(teacher => {
                        const workStatus = (teacher['ì¬ì§êµ¬ë¶„'] || '').toString().trim();
                        const position = teacher['ì§ë ¬'];

                        // í‡´ì§ì ì œì™¸ (í‡´ì§, ì˜ì›ë©´ì§, ì‚¬ë§ ë“±)
                        const isRetired = workStatus.includes('í‡´ì§') ||
                                         workStatus.includes('ë©´ì§') ||
                                         workStatus.includes('ì‚¬ë§') ||
                                         workStatus === '';

                        // ì „ì„êµì›ë§Œ í¬í•¨
                        const isFullTime = position && position.toString().includes('ì „ì„êµì›');

                        return !isRetired && isFullTime;
                    });

                    if (facultyData.length === 0) {
                        alert('ì¬ì§ì¤‘ì¸ ì „ì„êµì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    filteredData = [...facultyData];

                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    StorageUtils.set('facultyData', facultyData);

                    updateUI();
                    showFacultyAnalysisResult(jsonData.length, facultyData);

                } catch (error) {
                    console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            if (facultyData.length === 0) return;

            // í†µê³„ ê³„ì‚°
            let tenureCount = 0;
            let nonTenureCount = 0;
            let professorCount = 0;
            let associateCount = 0;
            let assistantCount = 0;

            facultyData.forEach(teacher => {
                const rank = teacher['ì§ê¸‰'] || '';

                if (rank.includes('ë¹„ì •ë…„')) {
                    nonTenureCount++;
                } else {
                    tenureCount++;
                }

                if (rank.includes('êµìˆ˜') && !rank.includes('ì¡°êµìˆ˜') && !rank.includes('ë¶€êµìˆ˜')) {
                    professorCount++;
                } else if (rank.includes('ë¶€êµìˆ˜')) {
                    associateCount++;
                } else if (rank.includes('ì¡°êµìˆ˜')) {
                    assistantCount++;
                }
            });

            // í†µê³„ í‘œì‹œ
            document.getElementById('totalCount').textContent = facultyData.length;
            document.getElementById('tenureCount').textContent = tenureCount;
            document.getElementById('nonTenureCount').textContent = nonTenureCount;
            document.getElementById('professorCount').textContent = professorCount;
            document.getElementById('associateCount').textContent = associateCount;
            document.getElementById('assistantCount').textContent = assistantCount;

            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('actionCard').style.display = 'block';
            document.getElementById('dataPreview').style.display = 'block';

            updateTable();
        }

        // êµì›í˜„í™© ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function showFacultyAnalysisResult(totalRecords, filteredData) {
            const resultDiv = document.getElementById('facultyAnalysisResult');
            const contentDiv = document.getElementById('facultyAnalysisContent');

            // í†µê³„ ê³„ì‚°
            let tenureCount = 0;
            let nonTenureCount = 0;
            let professorCount = 0;
            let associateCount = 0;
            let assistantCount = 0;

            filteredData.forEach(teacher => {
                const rank = teacher['ì§ê¸‰'] || '';
                if (rank.includes('ë¹„ì •ë…„')) {
                    nonTenureCount++;
                } else {
                    tenureCount++;
                }
                if (rank.includes('êµìˆ˜') && !rank.includes('ì¡°êµìˆ˜') && !rank.includes('ë¶€êµìˆ˜')) {
                    professorCount++;
                } else if (rank.includes('ë¶€êµìˆ˜')) {
                    associateCount++;
                } else if (rank.includes('ì¡°êµìˆ˜')) {
                    assistantCount++;
                }
            });

            const excludedCount = totalRecords - filteredData.length;

            contentDiv.innerHTML = `
                <div style="padding: var(--spacing-sm); background: var(--bg-primary); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md); font-size: var(--font-size-sm); color: var(--text-secondary);">
                    ğŸ“Š ì „ì²´ ${totalRecords.toLocaleString()}ê±´ ì¤‘ ì¬ì§ì¤‘ì¸ ì „ì„êµì› <strong>${filteredData.length.toLocaleString()}ê±´</strong> ë¶„ì„ ì™„ë£Œ
                    (í‡´ì§ì ë° ë¹„ì „ì„ ${excludedCount.toLocaleString()}ê±´ ì œì™¸)
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: var(--spacing-sm);">
                    <div style="padding: var(--spacing-sm); background: white; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-primary);">${tenureCount}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">ì •ë…„íŠ¸ë™</div>
                    </div>
                    <div style="padding: var(--spacing-sm); background: white; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-warning);">${nonTenureCount}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">ë¹„ì •ë…„íŠ¸ë™</div>
                    </div>
                    <div style="padding: var(--spacing-sm); background: white; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-success);">${professorCount}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">êµìˆ˜</div>
                    </div>
                    <div style="padding: var(--spacing-sm); background: white; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: var(--font-size-xl); font-weight: 600; color: var(--text-primary);">${associateCount}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">ë¶€êµìˆ˜</div>
                    </div>
                    <div style="padding: var(--spacing-sm); background: white; border-radius: var(--radius-sm); text-align: center;">
                        <div style="font-size: var(--font-size-xl); font-weight: 600; color: var(--text-primary);">${assistantCount}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">ì¡°êµìˆ˜</div>
                    </div>
                </div>
                <p style="color: var(--text-muted); font-size: var(--font-size-sm); margin-top: var(--spacing-md);">
                    âœ“ ë°ì´í„°ê°€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íƒ­ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </p>
            `;

            resultDiv.style.display = 'block';
        }

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                `;
                return;
            }

            filteredData.slice(0, 100).forEach(teacher => {
                const firstAppointment = DateUtils.parseDate(getTeacherValue(teacher, 'ì „ì„êµì›\nìµœì´ˆì„ìš©ì¼'));
                const renewalStart = DateUtils.parseDate(teacher['ì¬ì„ìš©ì‹œì‘ì¼']);
                const renewalEnd = DateUtils.parseDate(teacher['ì¬ì„ìš©ì¢…ë£Œì¼']);
                const initialEnd = DateUtils.parseDate(getTeacherValue(teacher, 'ìµœì´ˆì„ìš©\nì¢…ë£Œì¼'));
                const endDate = renewalEnd || initialEnd;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${teacher['ì„±ëª…'] || '-'}</td>
                    <td>${teacher['ì†Œì†'] || '-'}</td>
                    <td>${teacher['ì§ê¸‰'] || '-'}</td>
                    <td>${DateUtils.formatDate(firstAppointment)}</td>
                    <td>${DateUtils.formatDate(renewalStart)}</td>
                    <td>${DateUtils.formatDate(endDate)}</td>
                    <td>${teacher['ì¬ì§êµ¬ë¶„'] || '-'}</td>
                `;
                tbody.appendChild(row);
            });

            if (filteredData.length > 100) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="text-center p-3 text-muted">
                        ${filteredData.length}ëª… ì¤‘ ìƒìœ„ 100ëª…ë§Œ í‘œì‹œë©ë‹ˆë‹¤
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // ê²€ìƒ‰ í•„í„°
        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            filteredData = facultyData.filter(teacher => {
                const name = (teacher['ì„±ëª…'] || '').toLowerCase();
                const department = (teacher['ì†Œì†'] || '').toLowerCase();
                const rank = (teacher['ì§ê¸‰'] || '').toLowerCase();

                return name.includes(searchTerm) ||
                       department.includes(searchTerm) ||
                       rank.includes(searchTerm);
            });

            updateTable();
        }

        // ë°ì´í„° ì´ˆê¸°í™”
        function clearData() {
            if (!confirm('ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            facultyData = [];
            filteredData = [];
            StorageUtils.remove('facultyData');

            document.getElementById('fileInfo').classList.remove('show');
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('actionCard').style.display = 'none';
            document.getElementById('dataPreview').style.display = 'none';
            document.getElementById('fileInput').value = '';

            alert('ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸° (ì¤€ë¹„ ì¤‘)
        function exportData() {
            alert('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const uploadSection = document.getElementById('uploadSection');

        uploadSection.addEventListener('click', function(e) {
            if (e.target === uploadSection || e.target.closest('.upload-icon, .upload-title, .upload-description')) {
                document.getElementById('fileInput').click();
            }
        });

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('drag-over');
        });

        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const event = { target: { files: [files[0]] } };
                loadExcelFile(event);
            }
        });

        // ë°œë ¹ì‚¬í•­ íŒŒì¼ ë¡œë“œ ë° ë¶„ì„
        async function loadAppointmentFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            // íŒŒì¼ ì •ë³´ í‘œì‹œ
            const fileInfo = document.getElementById('appointmentFileInfo');
            const fileName = document.getElementById('appointmentFileName');
            const fileSize = document.getElementById('appointmentFileSize');

            fileName.textContent = file.name;
            fileSize.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
            fileInfo.classList.add('show');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    // í—¤ë” ì°¾ê¸°
                    let headerRowIndex = -1;
                    let headers = [];

                    for (let i = 0; i < rawData.length; i++) {
                        if (rawData[i] && rawData[i].includes('ì„±ëª…')) {
                            headerRowIndex = i;
                            headers = rawData[i];
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        throw new Error('í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°œë ¹ì‚¬í•­ ì—‘ì…€ íŒŒì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }

                    // ë°ì´í„° ì¶”ì¶œ
                    const actualDataRows = rawData.slice(headerRowIndex + 1).filter(row =>
                        row && row.length > 0
                    );

                    // ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
                    const appointmentData = actualDataRows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index];
                        });
                        return obj;
                    });

                    console.log('ë°œë ¹ì‚¬í•­ ë°ì´í„°:', appointmentData.length, 'ê±´');
                    console.log('ìƒ˜í”Œ ë°ì´í„°:', appointmentData[0]);

                    // ë°œë ¹ì‚¬í•­ ë°ì´í„° ì €ì¥ (êµì›ë³„ë¡œ ì¸ë±ì‹±)
                    saveAppointmentData(appointmentData);

                    // ì˜ˆì™¸ ì‚¬í•­ ìë™ ìƒì„±
                    analyzeAndCreateExceptions(appointmentData);

                } catch (error) {
                    console.error('ë°œë ¹ì‚¬í•­ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // ë°œë ¹ì‚¬í•­ ë°ì´í„° ì €ì¥ (êµì›ë³„ ì¸ë±ì‹±)
        function saveAppointmentData(appointmentData) {
            // êµì›ë³„ë¡œ ë°œë ¹ì‚¬í•­ ê·¸ë£¹í™”
            const appointmentByTeacher = {};

            appointmentData.forEach(record => {
                const name = record['ì„±ëª…'];
                const department = record['ì†Œì†'] || record['ë¶€ì„œ'] || record['í•™ê³¼'];

                if (!name) return;

                const key = `${name}_${department}`;

                if (!appointmentByTeacher[key]) {
                    appointmentByTeacher[key] = {
                        name: name,
                        department: department,
                        appointments: []
                    };
                }

                appointmentByTeacher[key].appointments.push(record);
            });

            // localStorageì— ì €ì¥
            StorageUtils.set('appointmentData', appointmentByTeacher);
            StorageUtils.set('appointmentDataUpdated', new Date().toISOString());

            console.log('ë°œë ¹ì‚¬í•­ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', Object.keys(appointmentByTeacher).length, 'ëª…');
        }

        // ë°œë ¹ì‚¬í•­ ë¶„ì„ ë° ì˜ˆì™¸ ì‚¬í•­ ìë™ ìƒì„±
        function analyzeAndCreateExceptions(appointmentData) {
            const promotionEngine = new PromotionEngine(new Date());
            const existingExceptions = promotionEngine.getExceptions();

            let createdExceptions = [];
            let resignationCount = 0;
            let otherCount = 0;
            let filteredCount = 0;

            appointmentData.forEach(record => {
                const name = record['ì„±ëª…'];
                const department = record['ì†Œì†'] || record['ë¶€ì„œ'] || record['í•™ê³¼'];
                const appointmentType = record['ë°œë ¹êµ¬ë¶„'] || record['ë°œë ¹ì‚¬ìœ '] || record['êµ¬ë¶„'];
                const appointmentDate = record['ë°œë ¹ì¼'] || record['ë°œë ¹ì¼ì'];
                const workStatus = record['ì¬ì§êµ¬ë¶„'];
                const position = record['ì§ë ¬'];

                if (!name || !appointmentType) return;

                // ì¬ì§ì¤‘ì¸ ì „ì„êµì›ë§Œ ì²˜ë¦¬
                const isActive = workStatus && workStatus.toString().trim().includes('ì¬ì§');
                const isFullTime = position && position.toString().includes('ì „ì„êµì›');

                if (!isActive || !isFullTime) {
                    filteredCount++;
                    return; // í‡´ì§ì ë° ë¹„ì „ì„ êµì› ì œì™¸
                }

                const typeStr = appointmentType.toString().toLowerCase();
                let exceptionType = null;
                let reason = appointmentType;

                // ì‚¬ì§ ê´€ë ¨ (ì¬ì§ì¤‘ì¸ êµì›ì˜ ì‚¬ì§ì„œ ì œì¶œë§Œ)
                if (typeStr.includes('ì‚¬ì§') || typeStr.includes('ì˜ì›ë©´ì§')) {
                    exceptionType = 'resignation';
                    resignationCount++;
                }
                // íœ´ì§ì€ ì˜ˆì™¸ë¡œ ë“±ë¡í•˜ì§€ ì•ŠìŒ
                // â†’ íœ´ì§ ê¸°ê°„ì€ promotion-engine.jsì˜ calculateLeaveMonths()ì—ì„œ
                //   ìŠ¹ì§„ ì˜ˆì •ì¼ì— ìë™ìœ¼ë¡œ ê°€ì‚° ì²˜ë¦¬ë¨ (êµì›ì¸ì‚¬ê·œì • ì œ15ì¡°)
                // ì§•ê³„ëŠ” ìë™ ë“±ë¡í•˜ì§€ ì•ŠìŒ
                // â†’ ë°œë ¹ì‚¬í•­ì˜ ì§•ê³„ ë°ì´í„°ëŠ” ì •í™•í•˜ì§€ ì•Šì•„ ë³„ë„ ì§•ê³„ì²˜ë¶„ íƒ­ì—ì„œ ìˆ˜ì‘ì—… ê´€ë¦¬
                //   (êµì›ì¸ì‚¬ê·œì • ì œ15ì¡°ì˜2 ì°¸ì¡°)

                if (exceptionType) {
                    // ì¤‘ë³µ í™•ì¸ (ê°™ì€ ì´ë¦„+ì†Œì†+ìœ í˜•+ìŠ¹ì§„ì¼ì´ ì´ë¯¸ ìˆëŠ”ì§€)
                    const targetPromotionDate = exceptionType === 'resignation' ? null : (appointmentDate || null);
                    const isDuplicate = existingExceptions.some(ex =>
                        ex.name === name &&
                        (!ex.department || ex.department === department) &&
                        ex.type === exceptionType &&
                        ex.promotionDate === targetPromotionDate
                    );

                    if (!isDuplicate) {
                        const exception = {
                            department: department || '',
                            name: name,
                            type: exceptionType,
                            promotionDate: exceptionType === 'resignation' ? null : (appointmentDate || null),
                            reason: reason,
                            note: `ë°œë ¹ì‚¬í•­ íŒŒì¼ì—ì„œ ìë™ ë“±ë¡ (${DateUtils.formatDate(new Date())})`,
                            isActive: true,
                            addedDate: new Date().toISOString()
                        };

                        existingExceptions.push(exception);
                        createdExceptions.push(exception);
                    }
                }
            });

            // ì˜ˆì™¸ ì‚¬í•­ ì €ì¥
            promotionEngine.saveExceptions(existingExceptions);

            // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            showAnalysisResult({
                total: createdExceptions.length,
                resignation: resignationCount,
                other: otherCount,
                filtered: filteredCount,
                totalRecords: appointmentData.length,
                exceptions: createdExceptions
            });
        }

        // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function showAnalysisResult(result) {
            const resultDiv = document.getElementById('appointmentAnalysisResult');
            const contentDiv = document.getElementById('appointmentAnalysisContent');

            // í•„í„°ë§ ì •ë³´ í‘œì‹œ
            const filteredInfo = result.filtered ? `
                <div style="padding: var(--spacing-sm); background: var(--bg-primary); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md); font-size: var(--font-size-sm); color: var(--text-secondary);">
                    ğŸ“Š ì „ì²´ ${result.totalRecords.toLocaleString()}ê±´ ì¤‘ ì¬ì§ì¤‘ì¸ ì „ì„êµì› ${(result.totalRecords - result.filtered).toLocaleString()}ê±´ ë¶„ì„ ì™„ë£Œ
                    (í‡´ì§ì ë° ë¹„ì „ì„ ${result.filtered.toLocaleString()}ê±´ ì œì™¸)
                </div>
            ` : '';

            if (result.total === 0) {
                contentDiv.innerHTML = filteredInfo + `
                    <p style="color: var(--text-secondary);">
                        ìƒˆë¡œìš´ ì˜ˆì™¸ ì‚¬í•­ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
                        (ì´ë¯¸ ë“±ë¡ëœ í•­ëª©ì´ê±°ë‚˜ ì‚¬ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤)
                    </p>
                    <p style="color: var(--text-muted); font-size: var(--font-size-sm);">
                        â€» íœ´ì§ ê¸°ê°„ì€ ì˜ˆì™¸ê°€ ì•„ë‹Œ ìŠ¹ì§„ì˜ˆì •ì¼ ìë™ ê°€ì‚°ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.<br>
                        â€» ì§•ê³„ëŠ” ìŠ¹ì§„ íƒ­ì˜ ì§•ê³„ì²˜ë¶„ ê´€ë¦¬ì—ì„œ ìˆ˜ì‘ì—…ìœ¼ë¡œ ë“±ë¡í•˜ì„¸ìš”.
                    </p>
                `;
            } else {
                let html = filteredInfo + `
                    <div style="margin-bottom: var(--spacing-md);">
                        <strong>${result.total}ê±´ì˜ ì˜ˆì™¸ ì‚¬í•­ì´ ìë™ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</strong>
                        <p style="color: var(--text-muted); font-size: var(--font-size-sm); margin-top: var(--spacing-xs);">
                            â€» íœ´ì§ ê¸°ê°„ì€ ì˜ˆì™¸ê°€ ì•„ë‹Œ ìŠ¹ì§„ì˜ˆì •ì¼ ìë™ ê°€ì‚°ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.<br>
                            â€» ì§•ê³„ëŠ” ìŠ¹ì§„ íƒ­ì˜ ì§•ê³„ì²˜ë¶„ ê´€ë¦¬ì—ì„œ ìˆ˜ì‘ì—…ìœ¼ë¡œ ë“±ë¡í•˜ì„¸ìš”.
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                        <div style="padding: var(--spacing-sm); background: white; border-radius: var(--radius-sm); text-align: center;">
                            <div style="font-size: var(--font-size-xl); font-weight: 600; color: var(--color-danger);">${result.resignation}</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">ì‚¬ì§ì„œ ì œì¶œ</div>
                        </div>
                    </div>
                    <div style="margin-top: var(--spacing-md);">
                        <a href="promotion.html" class="btn btn-primary">ìŠ¹ì§„ ê´€ë¦¬ì—ì„œ í™•ì¸í•˜ê¸°</a>
                    </div>
                `;

                contentDiv.innerHTML = html;
            }

            resultDiv.style.display = 'block';
        }

        // ë°œë ¹ì‚¬í•­ ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const appointmentUploadSection = document.getElementById('appointmentUploadSection');

        appointmentUploadSection.addEventListener('click', function(e) {
            if (e.target === appointmentUploadSection || e.target.closest('.upload-icon, .upload-title, .upload-description')) {
                document.getElementById('appointmentFileInput').click();
            }
        });

        appointmentUploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            appointmentUploadSection.classList.add('drag-over');
        });

        appointmentUploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            appointmentUploadSection.classList.remove('drag-over');
        });

        appointmentUploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            appointmentUploadSection.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const event = { target: { files: [files[0]] } };
                loadAppointmentFile(event);
            }
        });
    </script>
</body>
</html>
