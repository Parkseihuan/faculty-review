<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„° ê´€ë¦¬ - êµì› ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/navigation.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }

        .page-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-xl) 0;
            margin-bottom: var(--spacing-xl);
        }

        .page-title {
            font-size: var(--font-size-3xl);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .upload-section {
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            text-align: center;
            margin-bottom: var(--spacing-xl);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-section:hover {
            border-color: var(--color-primary);
            background: var(--bg-secondary);
        }

        .upload-section.drag-over {
            border-color: var(--color-primary);
            background: var(--bg-secondary);
        }

        .upload-section input {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }

        .upload-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .upload-description {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .file-info {
            display: none;
            background: var(--bg-secondary);
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-md);
        }

        .file-info.show {
            display: block;
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-box {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .data-preview {
            margin-top: var(--spacing-xl);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            max-height: 500px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand">êµì› ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            <button class="navbar-toggle" aria-label="ë©”ë‰´ í† ê¸€">
                <span class="navbar-toggle-icon"></span>
            </button>
            <ul class="navbar-menu">
                <li class="navbar-item">
                    <a href="index.html" class="navbar-link" data-page="dashboard">ëŒ€ì‹œë³´ë“œ</a>
                </li>
                <li class="navbar-item">
                    <a href="promotion.html" class="navbar-link" data-page="promotion">ìŠ¹ì§„</a>
                </li>
                <li class="navbar-item">
                    <a href="reappointment.html" class="navbar-link" data-page="reappointment">ì¬ì„ìš©</a>
                </li>
                <li class="navbar-item">
                    <a href="data-management.html" class="navbar-link" data-page="data">ë°ì´í„° ê´€ë¦¬</a>
                </li>
                <li class="navbar-item">
                    <a href="process.html" class="navbar-link" data-page="process">í”„ë¡œì„¸ìŠ¤ & ê·œì •</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header">
        <div class="container">
            <h1 class="page-title">ë°ì´í„° ê´€ë¦¬</h1>
            <p class="section-subtitle">êµì›í˜„í™© ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>
    </div>

    <div class="container">
        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <div class="upload-section" id="uploadSection">
            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="loadExcelFile(event)">
            <div class="upload-icon">ğŸ“Š</div>
            <h3 class="upload-title">êµì›í˜„í™© ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>
            <p class="upload-description">
                í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”<br>
                <small>(ì§€ì› í˜•ì‹: .xlsx, .xls)</small>
            </p>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                íŒŒì¼ ì„ íƒ
            </button>
            <div class="file-info" id="fileInfo">
                <strong id="fileName"></strong> - <span id="fileSize"></span>
            </div>
        </div>

        <!-- ë°ì´í„° í†µê³„ -->
        <div class="stats-section" id="statsSection" style="display: none;">
            <div class="stat-box">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">ì „ì²´ êµì›</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="tenureCount">0</div>
                <div class="stat-label">ì •ë…„íŠ¸ë™</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="nonTenureCount">0</div>
                <div class="stat-label">ë¹„ì •ë…„íŠ¸ë™</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="professorCount">0</div>
                <div class="stat-label">êµìˆ˜</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="associateCount">0</div>
                <div class="stat-label">ë¶€êµìˆ˜</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="assistantCount">0</div>
                <div class="stat-label">ì¡°êµìˆ˜</div>
            </div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="card" id="actionCard" style="display: none;">
            <div class="card-body">
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="clearData()">
                        ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”
                    </button>
                    <button class="btn btn-outline" onclick="exportData()">
                        ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸° <span class="coming-soon-badge" style="display: inline-block; padding: 2px 6px; background: var(--color-warning); color: var(--text-primary); border-radius: var(--radius-sm); font-size: 0.75rem; margin-left: 4px;">ì¤€ë¹„ì¤‘</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° -->
        <div class="data-preview" id="dataPreview" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="searchBox" placeholder="êµì›ëª…, ì†Œì†, ì§ê¸‰ ê²€ìƒ‰..." onkeyup="filterTable()">
                    </div>
                    <div class="table-wrapper">
                        <table class="table" id="dataTable">
                            <thead>
                                <tr>
                                    <th>ì„±ëª…</th>
                                    <th>ì†Œì†</th>
                                    <th>ì§ê¸‰</th>
                                    <th>ì„ìš©ì¼</th>
                                    <th>ì¬ì„ìš©ì‹œì‘ì¼</th>
                                    <th>ì¢…ë£Œì¼</th>
                                    <th>ì¬ì§êµ¬ë¶„</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr>
                                    <td colspan="7" class="empty-state">
                                        ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/navigation.js"></script>
    <script>
        let facultyData = [];
        let filteredData = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë³µì›
        document.addEventListener('DOMContentLoaded', function() {
            const savedData = StorageUtils.get('facultyData');
            if (savedData) {
                facultyData = savedData;
                filteredData = [...facultyData];
                updateUI();
            }
        });

        // í—¤ë”ëª… ì •ê·œí™”
        function getTeacherValue(teacher, fieldName) {
            const possibleKeys = [
                fieldName,
                fieldName.replace(/\r?\n/g, ''),
                fieldName.replace(/\r?\n/g, '\r\n'),
                fieldName.replace(/\r?\n/g, '\n')
            ];

            for (const key of possibleKeys) {
                if (teacher[key] !== undefined && teacher[key] !== null) {
                    return teacher[key];
                }
            }
            return null;
        }

        // ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        async function loadExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            // íŒŒì¼ ì •ë³´ í‘œì‹œ
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');

            fileName.textContent = file.name;
            fileSize.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
            fileInfo.classList.add('show');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    // í—¤ë” ì°¾ê¸°
                    let headerRowIndex = -1;
                    let headers = [];

                    for (let i = 0; i < rawData.length; i++) {
                        if (rawData[i] && rawData[i][0] === 'No.' && rawData[i].includes('ì„±ëª…')) {
                            headerRowIndex = i;
                            headers = rawData[i];
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        throw new Error('í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. êµì›í˜„í™© ì—‘ì…€ íŒŒì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }

                    // ë°ì´í„° ì¶”ì¶œ
                    const actualDataRows = rawData.slice(headerRowIndex + 1).filter(row =>
                        row && row.length > 0 && row[0] && typeof row[0] === 'number'
                    );

                    // ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
                    const jsonData = actualDataRows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index];
                        });
                        return obj;
                    });

                    // ì¬ì§ì¤‘ì¸ ì „ì„êµì›ë§Œ í•„í„°ë§
                    facultyData = jsonData.filter(teacher => {
                        const workStatus = teacher['ì¬ì§êµ¬ë¶„'];
                        const position = teacher['ì§ë ¬'];
                        return workStatus && workStatus.toString().includes('ì¬ì§') &&
                               position && position.toString().includes('ì „ì„êµì›');
                    });

                    if (facultyData.length === 0) {
                        alert('ì¬ì§ì¤‘ì¸ ì „ì„êµì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    filteredData = [...facultyData];

                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    StorageUtils.set('facultyData', facultyData);

                    updateUI();
                    alert(`ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nì „ì„êµì› ${facultyData.length}ëª…ì˜ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                } catch (error) {
                    console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            if (facultyData.length === 0) return;

            // í†µê³„ ê³„ì‚°
            let tenureCount = 0;
            let nonTenureCount = 0;
            let professorCount = 0;
            let associateCount = 0;
            let assistantCount = 0;

            facultyData.forEach(teacher => {
                const rank = teacher['ì§ê¸‰'] || '';

                if (rank.includes('ë¹„ì •ë…„')) {
                    nonTenureCount++;
                } else {
                    tenureCount++;
                }

                if (rank.includes('êµìˆ˜') && !rank.includes('ì¡°êµìˆ˜') && !rank.includes('ë¶€êµìˆ˜')) {
                    professorCount++;
                } else if (rank.includes('ë¶€êµìˆ˜')) {
                    associateCount++;
                } else if (rank.includes('ì¡°êµìˆ˜')) {
                    assistantCount++;
                }
            });

            // í†µê³„ í‘œì‹œ
            document.getElementById('totalCount').textContent = facultyData.length;
            document.getElementById('tenureCount').textContent = tenureCount;
            document.getElementById('nonTenureCount').textContent = nonTenureCount;
            document.getElementById('professorCount').textContent = professorCount;
            document.getElementById('associateCount').textContent = associateCount;
            document.getElementById('assistantCount').textContent = assistantCount;

            document.getElementById('statsSection').style.display = 'grid';
            document.getElementById('actionCard').style.display = 'block';
            document.getElementById('dataPreview').style.display = 'block';

            updateTable();
        }

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                `;
                return;
            }

            filteredData.slice(0, 100).forEach(teacher => {
                const firstAppointment = DateUtils.parseDate(getTeacherValue(teacher, 'ì „ì„êµì›\nìµœì´ˆì„ìš©ì¼'));
                const renewalStart = DateUtils.parseDate(teacher['ì¬ì„ìš©ì‹œì‘ì¼']);
                const renewalEnd = DateUtils.parseDate(teacher['ì¬ì„ìš©ì¢…ë£Œì¼']);
                const initialEnd = DateUtils.parseDate(getTeacherValue(teacher, 'ìµœì´ˆì„ìš©\nì¢…ë£Œì¼'));
                const endDate = renewalEnd || initialEnd;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${teacher['ì„±ëª…'] || '-'}</td>
                    <td>${teacher['ì†Œì†'] || '-'}</td>
                    <td>${teacher['ì§ê¸‰'] || '-'}</td>
                    <td>${DateUtils.formatDate(firstAppointment)}</td>
                    <td>${DateUtils.formatDate(renewalStart)}</td>
                    <td>${DateUtils.formatDate(endDate)}</td>
                    <td>${teacher['ì¬ì§êµ¬ë¶„'] || '-'}</td>
                `;
                tbody.appendChild(row);
            });

            if (filteredData.length > 100) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="text-center p-3 text-muted">
                        ${filteredData.length}ëª… ì¤‘ ìƒìœ„ 100ëª…ë§Œ í‘œì‹œë©ë‹ˆë‹¤
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // ê²€ìƒ‰ í•„í„°
        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            filteredData = facultyData.filter(teacher => {
                const name = (teacher['ì„±ëª…'] || '').toLowerCase();
                const department = (teacher['ì†Œì†'] || '').toLowerCase();
                const rank = (teacher['ì§ê¸‰'] || '').toLowerCase();

                return name.includes(searchTerm) ||
                       department.includes(searchTerm) ||
                       rank.includes(searchTerm);
            });

            updateTable();
        }

        // ë°ì´í„° ì´ˆê¸°í™”
        function clearData() {
            if (!confirm('ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            facultyData = [];
            filteredData = [];
            StorageUtils.remove('facultyData');

            document.getElementById('fileInfo').classList.remove('show');
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('actionCard').style.display = 'none';
            document.getElementById('dataPreview').style.display = 'none';
            document.getElementById('fileInput').value = '';

            alert('ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸° (ì¤€ë¹„ ì¤‘)
        function exportData() {
            alert('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const uploadSection = document.getElementById('uploadSection');

        uploadSection.addEventListener('click', function(e) {
            if (e.target === uploadSection || e.target.closest('.upload-icon, .upload-title, .upload-description')) {
                document.getElementById('fileInput').click();
            }
        });

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('drag-over');
        });

        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const event = { target: { files: [files[0]] } };
                loadExcelFile(event);
            }
        });
    </script>
</body>
</html>
